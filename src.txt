//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// main ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//loadScript("script loader");

var game;
var nullCamera;
var blankCanvas;
var loadedImages;
var playerName = "Cass";
var teamName = "Mighty Dogs";
var baseName = "Mighty Base";

function main()
{
  loadedImages = new ImageMap();
  loadAllImages();

  nullCamera = new Camera(0, 0, 1);
  blankCanvas = document.createElement("canvas");

  game = new Game();
  game.start();

  document.addEventListener("keydown", game.keyDown.bind(game));
  document.addEventListener("keyup", game.keyUp.bind(game));
  document.addEventListener("click", game.click.bind(game));
  document.addEventListener("mousemove", game.mousemove.bind(game));
}

function loadScript(scriptName)
{
  var s = document.createElement("script");
  s.setAttribute("type", "text/javascript");
  s.setAttribute("src", getSrc(scriptName + ".txt"));
  document.body.appendChild(s);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// src-online /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function getSrc(path)
{
  return "http://cdn.rawgit.com/Fazness87/Biehn/master/" + path;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Camera ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Camera(x, y, zoom)
{
  this.x = x;
  this.y = y;
  this.zoom = zoom;
}

Camera.prototype.setX = function(x)
{
  this.x = x;
};

Camera.prototype.getX = function()
{
  return this.x;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Canvas ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Canvas(x, y, w, h)
{
  this.baseWidth = w;
  this.baseHeight = h;

  this.canvas = document.createElement("canvas");
  this.canvas.style.position = "absolute";
  this.canvas.style.left = x + "px";
  this.canvas.style.top = y + "px";
  document.body.appendChild(this.canvas);

  this.ctx = this.canvas.getContext("2d");
}

Canvas.prototype.reset = function()
{
  this.canvas.width = asWidth(this.baseWidth);
  this.canvas.height = asHeight(this.baseHeight);

  this.ctx.clearRect(0, 0, asWidth(1), asHeight(1));
};

Canvas.prototype.drawImage = function(img, x, y, w, h, hFlip, camera, transparency)
{
  this.ctx.globalAlpha = 1 - transparency;

  if (hFlip)
  {
    this.ctx.translate(asWidth(x) + asWidth(w) - asWidth(camera.x), asHeight(y) - asHeight(camera.y));
    this.ctx.scale(-1, 1);
    this.ctx.drawImage(img, 0, 0, asWidth(w), asHeight(h));
  }
  else
  {
    this.ctx.translate(-asWidth(camera.x), -asHeight(camera.y));
    this.ctx.drawImage(img, asWidth(x), asHeight(y), asWidth(w), asHeight(h));
  }

  this.ctx.setTransform(1, 0, 0, 1, 0, 0);
};

Canvas.prototype.colourRect = function(colour, x, y, w, h, camera, transparency)
{
  this.ctx.globalAlpha = 1 - transparency;
  this.ctx.translate(-asWidth(camera.x), -asHeight(camera.y));
  this.ctx.fillStyle = colour;
  this.ctx.fillRect(asWidth(x), asHeight(y), asWidth(w), asHeight(h));
  this.ctx.setTransform(1, 0, 0, 1, 0, 0);
};

Canvas.prototype.colourPolygon = function(colour, points, camera, transparency)
{
  this.ctx.globalAlpha = 1 - transparency;
  this.ctx.translate(-asWidth(camera.x), -asHeight(camera.y));
  this.ctx.fillStyle = colour;
  this.ctx.beginPath();
  this.ctx.moveTo(asWidth(points[0].x), asHeight(points[0].y));

  for (var i = 1; i < points.length; i++)
  {
    this.ctx.lineTo(asWidth(points[i].x), asHeight(points[i].y));
  }

  this.ctx.closePath();
  this.ctx.fill();
  this.ctx.setTransform(1, 0, 0, 1, 0, 0);
};

Canvas.prototype.patternRect = function(pattern, x, y, w, h, camera, repeatStyle, transparency)
{
  this.colourRect(this.ctx.createPattern(pattern, repeatStyle), x, y, w, h, camera, transparency);
};

Canvas.prototype.patternPolygon = function(pattern, points, camera, repeatStyle, transparency)
{
  this.colourPolygon(this.ctx.createPattern(pattern, repeatStyle), points, camera, transparency);
};

Canvas.prototype.colourCircle = function(x, y, radius, r, g, b, transparency, camera)
{
  this.ctx.globalAlpha = 1 - transparency;
  this.ctx.translate(-asWidth(camera.x), -asHeight(camera.y));
  this.ctx.fillStyle = "rgb(" + Math.round(r) + ", " + Math.round(g) + ", " + Math.round(b) + ")";
  this.ctx.beginPath();
  this.ctx.arc(asWidth(x), asHeight(y), asWidth(radius), 0, 2 * Math.PI);
  this.ctx.fill();
  this.ctx.setTransform(1, 0, 0, 1, 0, 0);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////// Character Skill Set  ////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function CharacterSkillSet(soldier, research, construction, intel, medic)
{
  this.skillMap = new Map();
  this.skillMap.set("Soldier", new CharacterSkill("Soldier", soldier));
  this.skillMap.set("Research", new CharacterSkill("Research", research));
  this.skillMap.set("Construction", new CharacterSkill("Construction", construction));
  this.skillMap.set("Intel", new CharacterSkill("Intel", intel));
  this.skillMap.set("Medic", new CharacterSkill("Medic", medic));
}

CharacterSkillSet.prototype.getSkillValue = function(skillId)
{
  return this.skillMap.get(skillId).getValue();
};

CharacterSkillSet.prototype.toString = function()
{
  var s = "";
  var arr = Array.from(this.skillMap.values());

  for (var i = 0; i < arr.length; i++)
  {
    if (i > 0) {s = s + " \n ";}
    s = s + arr[i].toString();
  }

  return s;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// Character Skill  //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function CharacterSkill(skillId, grade)
{
  this.skillId = skillId;
  this.grade = grade;
}

CharacterSkill.prototype.getValue = function()
{
  switch (this.grade)
  {
    case "S++":
    return 500;

    case "S+":
    return 350;

    case "S":
    return 250;

    case "A++":
    return 150;

    case "A+":
    return 100;

    case "A":
    return 50;

    case "B":
    return 20;

    case "C":
    return 10;

    case "D":
    return 4;

    case "E":
    return 1;

    default:
    return 1;
  }
};

CharacterSkill.prototype.toString = function()
{
  return this.skillId + ": " + this.grade;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////// Character Status Map ////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function CharacterStatusMap()
{
  this.map = new Map();
}

CharacterStatusMap.prototype.get = function(id)
{
  return this.map.get(id);
};

CharacterStatusMap.prototype.set = function(char, state)
{
  this.map.set(char.id, new CharacterStatus(char, state));
};

CharacterStatusMap.prototype.clearChar = function(id)
{
  return this.map.get(id).char = null;
};

CharacterStatusMap.prototype.registerDeath = function(char)
{
  this.set(char, "dead");
};

CharacterStatusMap.prototype.registerRescued = function(char)
{
  this.set(char, "rescued");
};

CharacterStatusMap.prototype.charIsDead = function(id)
{
  var x = this.map.get(id);

  return x != null && x.isDead();
};

CharacterStatusMap.prototype.charIsRescued = function(id)
{
  var x = this.map.get(id);

  return x != null && x.isRescued();
};

CharacterStatusMap.prototype.charIsNeutralised = function(id)
{
  var x = this.map.get(id);

  return x != null && x.isNeutralised();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// Character Status //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function CharacterStatus(char, state)
{
  this.id = char.id;
  this.char = char;
  this.state = state;
}

CharacterStatus.prototype.isDead = function()
{
  return this.state == "dead";
};

CharacterStatus.prototype.isRescued = function()
{
  return this.state == "rescued";
};

CharacterStatus.prototype.isNeutralised = function()
{
  return this.isDead() || this.isRescued();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Character  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Character(id, room, x, y, hFlip, patrolRoute, skillSet)
{
  this.id = id;
  this.room = room;
  this.x = x;
  this.y = y;
  this.hFlip = hFlip;
  this.patrolRoute = patrolRoute;
  this.skillSet = skillSet;

  if (this.id != "player") {this.room.addCharacter(this);}

  this.isPlayer = false;
  this.gun = null;
  this.item = null;
  this.chosenMoveDirection = 0;
  this.previousMoveDirection = 0;
  this.xForce = 0;
  this.birth = getTime();
  this.timeOfDeath = 0;
  this.interactCount = 0;
  this.lastInteract = 0;
  this.burning = 0;
  this.burnScream = null;
  this.sizzle = null;
  this.flameSprite = new Sprite("flame", "normal");
  this.knifeSprite = null;
  this.rescued = false;
  this.timeOfRescue = 0;
  this.murderWitnessTime = 0;
  this.activeAnimation = "";
  this.walkStartTime = 0;

  this.handlePointMap = new Map();
  this.handlePointMap.set("hand1", new SpriteHandlePoint("hand1", new Point(0, 0)));
  this.hand1 = this.handlePointMap.get("hand1").point;
}

Character.prototype.setAsPlayer = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.005;
  this.sprite = null;
  this.maxHp = game.getPlayerMaxHp();
  this.hp = game.playerHp;
  if (this.hp == 0) {this.setHp(this.maxHp);}
  this.shootOnSight = false;
  this.isPlayer = true;
  this.isForeground = true;
  this.knifeSprite = new Sprite("knife", "ready");

  if (game.equippedGun != null)
  {
    game.equippedGun.character = this;
    this.addGun(game.equippedGun);
  }

  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 200), new Rgb(242, 242, 222), new Rgb(125, 200, 100), new Rgb(222, 211, 200), new Rgb(200, 225, 90));};
};

Character.prototype.addGun = function(g)
{
  this.gun = g;
};

Character.prototype.addItem = function(i)
{
  this.item = i;
};

Character.prototype.doTime = function()
{
  if (this.room.world.stageStarted && (!this.isPlayer && this.room.knifedCharacter != this || this.isPlayer && this.room.knifedCharacter == null))
  {
    if (!this.isDead() && !this.isPlayer && !this.isBurning() && !this.rescued) {this.checkAI();}

    this.checkMovement();
  }

  this.snapToGround();

  this.checkBurning();

  this.checkAnimation();
};

Character.prototype.isThreat = function()
{
  return this.shootOnSight && this.gun != null && !this.isDead() && !this.rescued;
};

Character.prototype.checkBurning = function()
{
  var alive = !this.isDead();

  if (this.isBurning())
  {
    this.setHp(this.hp - 1);
    this.r *= 0.995;
    this.g *= 0.99;
    this.b *= 0.99;

    if (!this.isPlayer && alive && this.isDead()) {this.registerKill();}

    if (alive && this.burnScream == null) {this.burnScream = playSound("burn/scream", false);}
    else if (this.burnScream != null && this.burnScream.toDelete()) {this.burnScream = null;}

    if (this.sizzle == null)
    {
      this.sizzle = playSound("burn/sizzle", true);
    }
    else
    {
      var v = Math.min(Math.max((this.burning - getTime()) / 1000, 0), 1);
      this.sizzle.setVolume(v);
    }
  }
  else if (this.sizzle != null)
  {
    this.sizzle.trash();
    this.sizzle = null;
  }
};

Character.prototype.setOnFire = function()
{
  return this.burning = getTime() + 5000;
};

Character.prototype.isBurning = function()
{
  return getTime() < this.burning && !this.rescued;
};

Character.prototype.checkAnimation = function()
{
  var ani = "standing";

  if (this.hp == 0 || this.hostage) {ani = "dead";}
  else if (this.isBurning()) {ani = "burning";}
  else if (this.room.knifedCharacter != null && this.isPlayer) {ani = "stabbing";}
  else if (this == this.room.knifedCharacter) {ani = "getting stabbed";}
  else if (this.isSurprised()) {ani = "surprised";}
  else if (this.room.world.stageEnded && this.isPlayer) {ani = "celebrate";}
  else if (this.chosenMoveDirection != 0) {ani = "walking"; if (this.activeAnimation != ani) {this.walkStartTime = 0;}}

  if (this.sprite != null)
  {
    this.sprite.ensureAnimation(ani);
  }
  else
  {
    this.activeAnimation = ani;
  }
};

Character.prototype.hit = function(attacker, fromRight, damage, shotForce, burn, weaponType)
{
  if (!this.isDead() && !this.rescued)
  {
    var dir = 1;
    if (fromRight) {dir = -1;}

    if (shotForce != 0) {this.xForce = shotForce * dir;}
    this.setHp(this.hp - damage);

    if (this.hp == 0)
    {
      if (weaponType == "tranq")
      {
        this.rescue();
        playSound("sleep/0", false);
      }
      else
      {
        this.xForce *= 2;
        this.hFlip = fromRight;

        if (this.isPlayer) {attacker.taunt();}
        else {this.registerKill();}

        playSound("die/0", false);
      }
    }

    if (burn) {this.setOnFire();}

    if (weaponType == "bullet")
    {
      this.room.addBloodSplat(this.x + this.w / 2, this.y + this.h / 2, fromRight, shotForce, damage);
    }
  }
};

Character.prototype.registerKill = function()
{
  game.kills++;

  this.room.world.dialogBox.reset();
};

Character.prototype.registerDeath = function()
{
  this.room.world.registerDeath(this);
};

Character.prototype.rescue = function()
{
  if (!this.rescued)
  {
    this.room.world.registerRescued(this);
    this.rescued = true;
    this.timeOfRescue = getTime();
  }
};

Character.prototype.untieHostage = function()
{
  this.hostage = false;
};

Character.prototype.suicide = function(n)
{
  this.setHp(0);
};

Character.prototype.setHp = function(n)
{
  var currentHp = this.hp;

  this.hp = Math.min(Math.max(n, 0), this.maxHp);
  if (this.isPlayer) {game.playerHp = this.hp;}

  if (this.room != null && !this.room.world.stageEnded)
  {
    if (currentHp > 0 && this.hp == 0)
    {
      this.timeOfDeath = getTime();
      this.disarm(this.xForce);

      if (!this.isPlayer) {this.registerDeath();}

      this.room.checkWitnesses(this);
    }
  }
};

Character.prototype.checkAsWitness = function(char)
{
  if (this.maxHp == 1 && (this.hFlip && char.x < this.x && char.x + char.w > this.x - 0.4 || !this.hFlip && char.x + char.w > this.x + this.w && char.x < this.x + this.w + 0.4))
  {
    this.murderWitnessTime = getTime() + 3000;
  }
};

Character.prototype.isSurprised = function()
{
  return this.murderWitnessTime > getTime();
};

Character.prototype.collectGun = function(g)
{
  if (g.collect())
  {
    g.character = this;
    this.addGun(g);
    game.equippedGun = g;
  }
};

Character.prototype.collectItem = function(i)
{
  i.collect();
};

Character.prototype.disarm = function(fromRight)
{
  if (this.gun != null)
  {
    this.gun.disarm(fromRight);
    this.gun = null;
  }

  if (this.item != null)
  {
    this.item.scatter(fromRight);
    this.item = null;
  }
};

Character.prototype.recoil = function(intensity)
{
  var dir = -1;
  if (this.hFlip) {dir = 1;}

  this.xForce = intensity * dir;
};

Character.prototype.isDead = function()
{
  return this.timeOfDeath != 0;
};

Character.prototype.checkControls = function(controls)
{
  if (!this.isDead() && this.room.world.stageStarted && !this.room.world.stageEnded)
  {
    var goLeft = controls.getKeyState(37) > 0;
    var goRight = controls.getKeyState(39) > 0;

    if (goLeft) {this.chosenMoveDirection = -1;}
    else if (goRight) {this.chosenMoveDirection = 1;}
    else {this.chosenMoveDirection = 0;}

    if (controls.getKeyState(38) == 1) {this.room.tryInteract(this.x + this.w / 2);}

    var attackKey = controls.getKeyState(90);
    this.tryAttack(attackKey);

    if (goLeft || goRight || attackKey > 0)
    {
      this.room.world.dialogBox.stopTalking();
    }
  }
  else
  {
    this.chosenMoveDirection = 0;
  }

  this.room.world.dialogBox.checkControls(controls);
};

Character.prototype.tryInteract = function(x)
{
  if (typeof this.interact != "undefined" && !this.isDead() && !this.isBurning() && !this.rescued && x < this.x + this.w && x > this.x)
  {
    this.interactCount++;
    this.lastInteract = getTime();
    this.interact();
    return true;
  }

  return false;
};

Character.prototype.tryAttack = function(key)
{
  if (key > 0)
  {
    var c = this.room.getCharacterInMeleeRange(this);

    if (c == null)
    {
      this.tryShoot(key);
    }
    else if (key == 1 && this.room.knifedCharacter == null)
    {
      var x = this.x + this.w / 2;
      if (this.hFlip) {x -= c.w;}

      c.hFlip = this.hFlip;
      c.x = x;
      this.room.setKnifedCharacter(c);
    }
  }
  else if (this.room.knifedCharacter != null)
  {
    this.room.knifedCharacter.setHp(0);
    this.room.releaseKnifedCharacter();
    this.room.setKnifedCharacter(null);
  }
};

Character.prototype.tryShoot = function(key)
{
  if (this.gun != null) {this.gun.tryShoot(key);}
};

Character.prototype.checkAI = function()
{
  if (!this.room.world.stageEnded && getTime() > this.lastInteract + 10000 && !this.isSurprised())
  {
    this.chosenMoveDirection = this.patrolRoute.getMoveDirection(this.x + this.w / 2);
  }
  else
  {
    this.chosenMoveDirection = 0;
  }

  if (!this.room.world.stageEnded && !this.room.world.player.isDead() && this.playerInGunRange() && this.shootOnSight) {this.tryShoot(1);}
};

Character.prototype.playerInGunRange = function()
{
  if (this.gun != null)
  {
    var gx = this.gun.getTipX();
    var x1, x2;
    var vision = this.gun.range;
    var px = this.room.world.player.x + this.room.world.player.w / 2;
    var pb = this.room.getBrightness(px);

    if (pb < 50)
    {
      return false;
    }
    else if (this.hFlip)
    {
      x1 = gx - vision; x2 = gx;
    }
    else
    {
      x1 = gx; x2 = gx + vision;
    }

    return px > x1 && px < x2;
  }
  else
  {
    return false;
  }
};

Character.prototype.checkMovement = function()
{
  if (this.isBurning() && !this.isPlayer)
  {
    if (this.chosenMoveDirection == 0 || Math.random() < 0.01) {this.chosenMoveDirection = Math.sign(Math.random() * 2 - 1);}
  }

  var walkMotion = 0;
  if (!this.isDead()) {walkMotion = this.chosenMoveDirection * this.speed;}

  this.xForce /= 1.07;
  if (Math.abs(this.xForce) < 0.0001 || Math.abs(walkMotion) > Math.abs(this.xForce) * 2) {this.xForce = 0;}

  var newX = this.x + this.xForce + walkMotion;

  this.x = Math.min(Math.max(newX, 0), this.room.stageWidth - this.w);

  if (this.chosenMoveDirection != 0) {this.hFlip = (this.chosenMoveDirection < 0);}

  this.previousMoveDirection = this.chosenMoveDirection;
};

Character.prototype.snapToGround = function()
{
  var y = this.room.getGroundYPosition(this.x + this.w / 2);

  this.y = y - this.h + 0.02;
};

Character.prototype.getHandlePoint = function(handleId)
{
  if (this.sprite != null)
  {
    return this.sprite.getHandlePoint(handleId);
  }
  else
  {
    return this.handlePointMap.get(handleId).point;
  }
};

Character.prototype.draw = function(canvas, camera)
{
  var bright = this.room.getBrightness(this.x + this.w / 2);
  var r = this.r * bright;
  var g = this.g * bright;
  var b = this.b * bright;

  var transparency = 0;
  if (this.isDead()) {transparency = Math.min(Math.max((getTime() - this.timeOfDeath - 5000) / 5000, 0), 1);}
  else if (this.rescued) {transparency = Math.min(Math.max((getTime() - this.timeOfRescue) / 5000, 0), 1);}

  if (this.sprite != null)
  {
    this.sprite.draw(canvas, this.x, this.y, this.w, this.h, 100, camera, this.hFlip, r, g, b, transparency);
  }
  else
  {
    canvas.ctx.globalAlpha = 1 - transparency;

    if (this.hFlip)
    {
      canvas.ctx.translate(asWidth(this.x) + asWidth(this.w) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
      canvas.ctx.scale(-1, 1);
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }
    else
    {
      canvas.ctx.translate(asWidth(this.x) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }

    canvas.ctx.setTransform(1, 0, 0, 1, 0, 0);
  }

  if (this.gun != null)
  {
    this.gun.draw(canvas, camera, bright);
  }
};

Character.prototype.drawAsForeground = function(canvas, camera)
{
  if (this != this.room.knifedCharacter && this.isForeground) {this.draw(canvas, camera);}
};

Character.prototype.drawAsBackground = function(canvas, camera)
{
  if (this != this.room.knifedCharacter && !this.isForeground) {this.draw(canvas, camera);}
};

Character.prototype.drawKnife = function(canvas, camera)
{
  var bright = this.room.getBrightness(this.x + this.w / 2);
  var w = this.w * 0.5;
  var x = this.x + this.w * 0.5;
  if (this.hFlip) {x -= w;}

  if (this.knifeSprite != null) {this.knifeSprite.draw(canvas, x, this.y + this.h * 0.3, w, this.h * 0.5, 100, camera, this.hFlip, bright, bright, bright, 0);}
};

Character.prototype.drawAsKnifed = function(canvas, camera)
{
  if (this == this.room.knifedCharacter) {this.draw(canvas, camera);}
};

Character.prototype.drawLight = function(canvas, camera)
{
  if (this.isBurning())
  {
    var vis = Math.min(Math.max((this.burning - getTime()) / 1000, 0), 1);

    this.flameSprite.draw(canvas, this.x, this.y, this.w, this.h, 100, camera, false, 255, 255, 255, 1 - vis);
  }
};

Character.prototype.toDelete = function()
{
  return this.isDead() && getTime() > this.timeOfDeath + 10000 || this.rescued && getTime() > this.timeOfRescue + 5000;
};

Character.prototype.taunt = function() {};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// Controls //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Controls()
{
  this.keys = new Map();
}

Controls.prototype.getKeyState = function(keyCode)
{
  var ret = 0;

  if (this.keys.has(keyCode))
  {
    var k = this.keys.get(keyCode);

    if (k.active)
    {
      if (k.previous) {ret = 2;}
      else {ret = 1;}
    }
    else
    {
      if (k.previous) {ret = -1;}
    }

    k.previous = k.active;
  }

  return ret;
};

Controls.prototype.setKeyState = function(keyCode, state)
{
  if (!this.keys.has(keyCode))
  {
    this.keys.set(keyCode, new KeyState(keyCode));
  }

  this.keys.get(keyCode).active = state;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Dialog Box /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function DialogBox(x, y, w, h, canvas, charactersPerLine, boxTransparency)
{
  this.x = x;
  this.y = y;
  this.w = w;
  this.h = h;
  this.canvas = canvas;
  this.charactersPerLine = charactersPerLine;
  this.boxTransparency = 0;
  if (typeof boxTransparency != "undefined") {this.boxTransparency = boxTransparency;}

  k = function(x) {return x.charCodeAt(0);};

  this.defaultKeys = [k("Q"), k("W"), k("E"), k("R"), k("T"), k("Y"), k("U"), k("I"), k("O"), k("P")];

  this.reset();
}

DialogBox.prototype.setDialog = function(txt, options, timeout)
{
  this.txt = txt;
  this.timeout = timeout;

  if (typeof options != "undefined") {this.options = options;}
  else {this.options = [];}

  for (var i = 0; i < this.options.length; i++)
  {
    this.options[i].key = this.defaultKeys[i];
  }

  this.readTime = this.txt.length * 50;
  this.lastBox = getTime();
};

DialogBox.prototype.appendDialog = function(txt)
{
  this.txt = this.txt + txt;
};

DialogBox.prototype.checkControls = function(controls)
{
  var answer = false;
  var txt = this.txt;

  for (var i = 0; i < this.options.length && !answer; i++)
  {
    answer = this.options[i].checkControls(controls);
  }

  if (answer && this.txt == txt) {this.reset();}
};

DialogBox.prototype.stopTalking = function()
{
  if (this.timeout == 0) {this.reset();}
};

DialogBox.prototype.reset = function()
{
  this.txt = "";
  this.options = [];
  this.lastBox = 0;
  this.readTime = 0;
  this.timeout = 0;
};

DialogBox.prototype.draw = function()
{
  var fade = 0;
  if (this.txt == "") {fade = 1;}
  else if (this.timeout != 0) {fade = (getTime() - this.lastBox - this.readTime) / (this.timeout + this.readTime);}

  var y = 0.1;
  var lineHeight = 0.07;
  var lines = convertParagraphToLinesArray(this.txt, this.charactersPerLine);

  if (fade < 1)
  {
    this.canvas.colourRect("#222", this.x, this.y, this.w, lineHeight * (lines.length + this.options.length + 1), nullCamera, 1 - (1 - fade) * (1 - this.boxTransparency));

    this.canvas.ctx.globalAlpha = 1 - fade;
    this.canvas.ctx.fillStyle = "#ddd";
    this.canvas.ctx.font = asWidth(0.025) + "px Century Gothic";

    for (var i = 0; i < lines.length; i++)
    {
      this.canvas.ctx.fillText(lines[i], asWidth(this.x + 0.02), asHeight(this.y + lineHeight * (i + 1)));
    }

    if (this.options.length > 0)
    {
      this.canvas.ctx.fillStyle = "#d66";

      for (var i = 0; i < this.options.length; i++)
      {
        this.canvas.ctx.fillText(String.fromCharCode(this.options[i].key) + ": " + this.options[i].txt, asWidth(this.x + 0.02), asHeight(this.y + lineHeight * (lines.length + i + 1)));
      }
    }
  }
  else if (this.txt != "")
  {
    this.reset();
  }
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Dialog Option  ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function DialogOption(txt, func)
{
  this.txt = txt;
  this.func = func;
}

DialogOption.prototype.checkControls = function(controls)
{
  if (controls.getKeyState(this.key) == 1)
  {
    this.func();

    return true;
  }

  return false;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Dispatch Point ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function DispatchPoint(id, x, y, danger, fuelCost, resourceId, capacity, refreshRate, isUnlockedFunc)
{
  this.id = id;
  this.x = x;
  this.y = y;
  this.danger = danger;
  this.fuelCost = fuelCost;
  this.resourceId = resourceId;
  this.capacity = capacity;
  this.refreshRate = refreshRate;
  this.isUnlocked = isUnlockedFunc;
  this.lastDispatch = 0;
}

DispatchPoint.prototype.select = function()
{
  return "Dispatching to " + this.id + " \n " + 
    "Cost of dispatch: Fuel x" + this.fuelCost + " \n Expected return: " + this.resourceId + " x" + this.getQuantity() +
    " \n Danger level: " + this.danger + ", Your combat level: " + game.motherBase.getSkillLevel("Soldier") +
    " \n Success probability: " + this.getSuccessChanceAsString();
};

DispatchPoint.prototype.dispatch = function()
{
  game.inventory.remove("Fuel", this.fuelCost);

  var prob = this.getSuccessChance();
  var success = 0;
  var msg = "";
  var staff = game.motherBase.getStaffCount();
  var casualties = 0;
  var casualtyReport = "";
  var medic = game.motherBase.getSkillLevel("Medic");
  var q = 0;

  for (var i = 1; i < 4; i++)
  {
    if (Math.random() < Math.pow(prob, i)) {success++;}
  }

  switch (success)
  {
    case 0:
    msg = "massive failure";
    casualties = Math.random() * 3 + 5;
    q = 0;
    break;

    case 1:
    msg = "failure";
    casualties = Math.random() * 2 + 2;
    q = Math.round(this.getQuantity() * 0.2);
    break;

    case 2:
    msg = "success";
    casualties = Math.random();
    q = Math.round(this.getQuantity());
    break;

    case 3:
    msg = "great success";
    casualties = Math.random() / 2;
    q = Math.round(this.getQuantity());
    break;
  }

  casualties *= 3 / Math.pow(medic + 9, 0.5);

  casualties = Math.min(Math.max(Math.round(casualties), 0), staff - 1);

  if (casualties > 0)
  {
    this.loseStaff(casualties);
    casualtyReport = " \n Staff Casualties: " + casualties + " died";
  }

  game.inventory.add(this.resourceId, q);

  this.lastDispatch = getTime();

  return "The mission was a " + msg + " \n Costs: \n Fuel for transportation: " + this.fuelCost + casualtyReport +
    " \n Rewards: \n " + this.resourceId + " x" + q;
};

DispatchPoint.prototype.loseStaff = function(amount)
{
  game.motherBase.removeNumberOfStaff(amount);
};

DispatchPoint.prototype.getQuantity = function()
{
  var t = (getTime() - this.lastDispatch) / 60000 * this.refreshRate;

  return Math.min(Math.max(Math.round(t), 0), this.capacity);
};

DispatchPoint.prototype.getSuccessChance = function()
{
  var lvl = game.motherBase.getSkillLevel("Soldier") - this.danger;

  return 1 - Math.pow(0.5, Math.pow(1.1, lvl));
};

DispatchPoint.prototype.getSuccessChanceAsString = function()
{
  return Math.round(this.getSuccessChance() * 100) + "%";
};

DispatchPoint.prototype.getHoverTxt = function()
{
  return "Dispatch to " + this.id + ". Danger: Level " + this.danger + ", Success: " + this.getSuccessChanceAsString() +
    " \n Reward: " + this.resourceId + " " + this.getQuantity() + " (Capacity: " + this.capacity + ") \n " +
    "Fuel Cost: " + this.fuelCost + ", Available: " + game.inventory.getAmount("Fuel");
};

DispatchPoint.prototype.costIsCovered = function()
{
  return game.inventory.has([["Fuel", this.fuelCost]]);
};

DispatchPoint.prototype.isAvailable = function()
{
  return game.motherBase.getStaffCount() > 0 && this.isUnlocked();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Dispatches /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Dispatches()
{
  this.map = new Map();

  this.add("Russia Oilfield", 0.7, 0.2, 5, 1200, "Fuel", 4000, 100, function() {return missionIsComplete("clearOilfield");});
}

Dispatches.prototype.add = function(id, x, y, danger, fuelCost, resourceId, capacity, refreshRate, isUnlockedFunc)
{
  var d = new DispatchPoint(id, x, y, danger, fuelCost, resourceId, capacity, refreshRate, isUnlockedFunc);

  this.map.set(id, d);
};

Dispatches.prototype.select = function(id)
{
  return this.map.get(id).select();
};

Dispatches.prototype.dispatch = function(id)
{
  return this.map.get(id).dispatch();
};

Dispatches.prototype.get = function(id)
{
  return this.map.get(id);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// Game ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
var soundController;

function Game()
{
  this.playerHp = 0;
  this.foodPoints = 0;
  this.motherBase = new MotherBase();
  this.inventory = new Inventory();
  this.kills = 0;
  this.motherBaseVisits = 0;
  this.equippedGun = null;

  this.weaponDevelopmentData = new Map();
  this.weaponDevelopmentData.set("Handgun", 1);
  this.weaponDevelopmentData.set("Tranquiliser Gun", 1);
  this.weaponDevelopmentData.set("Machine Gun", 0);
  this.weaponDevelopmentData.set("Shotgun", 0);
  this.weaponDevelopmentData.set("Flamethrower", 0);

  this.mapLocations = new MapLocations();
  this.missionStatusMap = new MissionStatusMap();
  this.structureStatusMap = new StructureStatusMap();
  this.characterStatusMap = new CharacterStatusMap();
  this.dispatches = new Dispatches();

  this.openingScene = null;
  this.menuScreen = null;
  this.world = null;
  this.activeScreen = null;
  this.canvas = new Canvas(0, 0, 1, 1);

  soundController = new SoundController();

  this.cheatCode();

  this.doTime();
}

Game.prototype.cheatCode = function()
{
  this.registerRescued({id: "Nimler", skillSet: null});
  this.missionStatusMap.registerComplete("rescueNimler");
  this.motherBaseVisits = 1;
  this.registerRescued({id: "Johnny", skillSet: null});
  this.missionStatusMap.registerComplete("rescueJohnny");
  this.registerRescued({id: "Carter", skillSet: null});
  this.missionStatusMap.registerComplete("rescueCarter");
  this.inventory.add("Cash", 5000);
  this.inventory.add("Fuel", 5000);
  this.inventory.add("Metal", 5000);
  this.inventory.add("Wood", 5000);
  this.inventory.add("Special Materials", 5000);
  this.inventory.add("Food", 999999);
}

Game.prototype.doTime = function()
{
  soundController.doTime();
  if (this.activeScreen != null) {this.activeScreen.doTime();}

  requestAnimationFrame(this.doTime.bind(this));
};

Game.prototype.getPlayerMaxHp = function()
{
  var initialHp = 0;
  var bestHp = 1000;
  var foodPeak = 100000;

  var x = 1 - Math.pow(0.5, Math.pow(1.2, (this.foodPoints - foodPeak) / 10000));

  return Math.round(x * (bestHp - initialHp) + initialHp - 71);
};

Game.prototype.addToStaff = function(char)
{
  this.motherBase.addStaff(char);
};

Game.prototype.removeFromStaff = function(char)
{
  this.motherBase.removeStaff(char);
};

Game.prototype.start = function()
{
  this.runOpeningScene();
};

Game.prototype.runOpeningScene = function()
{
  this.openingScene = new OpeningScene(this.canvas);
  this.menuScreen = null;
  this.world = null;
  this.activeScreen = this.openingScene;
};

Game.prototype.enterMenu = function()
{
  this.openingScene = null;
  this.menuScreen = new MenuScreen(this.canvas);
  this.world = null;
  this.activeScreen = this.menuScreen;
};

Game.prototype.enterWorld = function(id)
{
  this.openingScene = null;
  this.menuScreen = null;
  this.world = new World(id, this.canvas);
  this.activeScreen = this.world;
};

Game.prototype.registerBuilt = function(id)
{
  return this.structureStatusMap.registerBuilt(id);
};

Game.prototype.getCharacterStatus = function(id)
{
  return this.characterStatusMap.get(id);
};

Game.prototype.registerDeath = function(id)
{
  return this.characterStatusMap.registerDeath(id);
};

Game.prototype.registerRescued = function(id)
{
  return this.characterStatusMap.registerRescued(id);
};

Game.prototype.keyDown = function(e)
{
  if (typeof this.activeScreen.keyDown != "undefined")
  {
    this.activeScreen.keyDown(e);
  }
};

Game.prototype.keyUp = function(e)
{
  if (typeof this.activeScreen.keyUp != "undefined")
  {
    this.activeScreen.keyUp(e);
  }
};

Game.prototype.click = function(e)
{
  if (typeof this.activeScreen.click != "undefined")
  {
    this.activeScreen.click(e);
  }
};

Game.prototype.mousemove = function(e)
{
  if (typeof this.activeScreen.mousemove != "undefined")
  {
    this.activeScreen.mousemove(e);
  }
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// Gun  ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Gun(id, room, character, x, y, hFlip)
{
  this.id = id;
  this.room = room;
  this.character = character;
  this.x = x;
  this.y = y;

  if (this.character != null) {this.character.addGun(this);}
  else {this.room.addGun(this);}

  this.lastShot = 0;
  this.xForce = 0;
  this.collected = false;

  this.handlePointMap = new Map();
  this.handlePointMap.set("grip", new SpriteHandlePoint("grip", new Point(0, 0)));
  this.handlePointMap.set("tip", new SpriteHandlePoint("tip", new Point(0, 0)));
  this.grip = this.handlePointMap.get("grip").point;
  this.tip = this.handlePointMap.get("tip").point;
}

Gun.prototype.doTime = function()
{
  if (!this.collected && this.character == null)
  {
    this.checkMovement();
  }
};

Gun.prototype.checkMovement = function()
{
  this.xForce /= 1.15;
  if (Math.abs(this.xForce) < 0.0001) {this.xForce = 0;}

  this.x = Math.min(Math.max(this.x + this.xForce, 0), this.room.stageWidth - this.w);

  this.snapToGround();
};

Gun.prototype.tryInteract = function(x)
{
  if (x < this.x + this.w && x > this.x)
  {
    this.room.world.player.collectGun(this);
    return true;
  }

  return false;
};

Gun.prototype.collides = function(char)
{
  return this.character == null && char.x < this.x + this.w && char.x + char.w > this.x;
};

Gun.prototype.collect = function()
{
  if (!this.collected)
  {
    this.collected = true;
    playSound("guns/" + this.sound + "/pickup", false);
    return true;
  }

  return false;
};

Gun.prototype.snapToGround = function()
{
  var y = this.room.getGroundYPosition(this.x + this.w / 2);

  this.y = y - this.h + 0.02;
};

Gun.prototype.disarm = function(force)
{
  if (this.character != null)
  {
    this.x = this.getX();
    this.hFlip = this.character.hFlip;
    this.xForce = force;
    this.room = this.character.room;
    this.room.addGun(this);
    this.character = null;
    this.snapToGround();
  }
};

Gun.prototype.tryShoot = function(key)
{
  var t = getTime();

  if (t > this.lastShot + this.fireRate && (this.rapidFire || key == 1))
  {
    this.lastShot = t;

    this.fire();
  }
};

Gun.prototype.fire = function()
{
  this.character.room.world.dialogBox.stopTalking();

  var p = this.character.isPlayer;

  this.character.room.fireProjectile(this.character, this.getTipX(), this.getTipY(), this.character.hFlip, this.damage, this.range, this.shotForce, this.burn, !p, p, this.projectileType);

  playSound("guns/" + this.sound + "/shoot", false);

  this.character.recoil(this.recoil);
};

Gun.prototype.getTipX = function()
{
  var tipPoint = this.getHandlePoint("tip");

  if (this.character != null && this.character.hFlip)
  {
    return this.getX() + (1 - tipPoint.x) * this.w;
  }
  else
  {
    return this.getX() + tipPoint.x * this.w;
  }
};

Gun.prototype.getTipY = function()
{
  var tipPoint = this.getHandlePoint("tip");

  return this.getY() + tipPoint.y * this.h;
};

Gun.prototype.getX = function()
{
  if (this.character != null)
  {
    var handPoint = this.character.getHandlePoint("hand1");
    var gripPoint = this.getHandlePoint("grip");
    if (this.character.hFlip)
    {
      return this.character.x + (1 - handPoint.x) * this.character.w - (1 - gripPoint.x) * this.w;
    }
    else
    {
      return this.character.x + handPoint.x * this.character.w - gripPoint.x * this.w;
    }
  }
  else
  {
    return this.x;
  }
};

Gun.prototype.getY = function()
{
  if (this.character != null)
  {
    var handPoint = this.character.getHandlePoint("hand1");
    var gripPoint = this.getHandlePoint("grip");

    return this.character.y + handPoint.y * this.character.h - gripPoint.y * this.h;
  }
  else
  {
    return this.y;
  }
};

Gun.prototype.getHandlePoint = function(handleId)
{
  if (this.sprite != null)
  {
    return this.sprite.getHandlePoint(handleId);
  }
  else
  {
    return this.handlePointMap.get(handleId).point;
  }
};

Gun.prototype.draw = function(canvas, camera, brightness)
{
  var bright = brightness;
  var flip = this.hFlip;

  if (this.character != null) {flip = this.character.hFlip;}
  else {bright = this.room.getBrightness(this.x + this.w / 2);}

  if (this.sprite != null)
  {
    this.sprite.draw(canvas, this.getX(), this.getY(), this.w, this.h, 1000, camera, flip, bright, bright, bright, 0);
  }
  else
  {
    canvas.ctx.globalAlpha = 1;

    if (flip)
    {
      canvas.ctx.translate(asWidth(this.getX()) + asWidth(this.w) - asWidth(camera.x), asHeight(this.getY()) - asHeight(camera.y));
      canvas.ctx.scale(-1, 1);
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }
    else
    {
      canvas.ctx.translate(asWidth(this.getX()) - asWidth(camera.x), asHeight(this.getY()) - asHeight(camera.y));
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }

    canvas.ctx.setTransform(1, 0, 0, 1, 0, 0);
  }
};

Gun.prototype.toDelete = function()
{
  return this.collected;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Image Map  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function ImageMap()
{
  this.map = new Map();
}

ImageMap.prototype.getTintedImage = function(imageName, r, g, b)
{
  return this.map.get(imageName).getTintedImage(r, g, b);
};

ImageMap.prototype.getImage = function(imageName)
{
  return this.map.get(imageName).original;
};

ImageMap.prototype.getHandlePoint = function(imageName, handleId)
{
  return this.map.get(imageName).getHandlePoint(handleId);
};

ImageMap.prototype.has = function(imageName)
{
  return this.map.has(imageName);
};

ImageMap.prototype.set = function(imageName, handlePoints)
{
  this.map.set(imageName, new SpriteData(imageName, handlePoints));
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Inventory  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Inventory()
{
  this.map = new Map();
  this.add("Cash", 0);
  this.add("Fuel", 0);
  this.add("Metal", 0);
  this.add("Wood", 0);
  this.add("Special Materials", 0);
  this.add("Food", 0);
}

Inventory.prototype.add = function(id, amount)
{
  if (this.map.has(id))
  {
    this.map.get(id).add(amount);
  }
  else
  {
    this.map.set(id, new Stock(id, amount));
  }
};

Inventory.prototype.remove = function(id, amount)
{
  if (this.map.has(id))
  {
    this.map.get(id).remove(amount);
  }
};

Inventory.prototype.use = function(arr)
{
  if (this.has(arr))
  {
    for (var i = 0; i < arr.length; i++)
    {
      this.remove(arr[i][0], arr[i][1]);
    }

    return true;
  }

  return false;
};

Inventory.prototype.has = function(arr)
{
  for (var i = 0; i < arr.length; i++)
  {
    if (this.getAmount(arr[i][0]) < arr[i][1]) {return false;}
  }

  return true;
};

Inventory.prototype.getAmount = function(id)
{
  if (this.map.has(id))
  {
    return this.map.get(id).getAmount();
  }

  return 0;
};

Inventory.prototype.get = function(id)
{
  if (this.map.has(id))
  {
    return this.map.get(id);
  }

  return null;
};

Inventory.prototype.toString = function(separator)
{
  var s = "";
  var sep = typeof separator != "undefined" ? separator : ", ";
  var arr = Array.from(this.map.values());

  for (var i = 0; i < arr.length; i++)
  {
    if (arr[i].getAmount() > 0)
    {
      if (s != "") {s = s + sep;}
      s = s + arr[i].toString();
    }
  }

  if (s == "") {s = "Inventory is empty.";}

  return s;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// Item ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Item(id, room, character, x, y)
{
  this.id = id;
  this.room = room;
  this.character = character;
  this.x = x;
  this.y = y;

  if (this.character != null) {this.character.addItem(this);}
  else {this.room.addItem(this);}

  this.xForce = 0;
  this.collected = false;
}

Item.prototype.doTime = function()
{
  if (!this.collected && this.character == null)
  {
    this.checkMovement();
  }
};

Item.prototype.checkMovement = function()
{
  this.xForce /= 1.1;
  if (Math.abs(this.xForce) < 0.0001) {this.xForce = 0;}

  this.x = Math.min(Math.max(this.x + this.xForce, 0), this.room.stageWidth - this.w);

  this.snapToGround();
};

Item.prototype.collides = function(char)
{
  return this.character == null && char.x < this.x + this.w && char.x + char.w > this.x;
};

Item.prototype.collect = function()
{
  if (!this.collected)
  {
    game.inventory.add(this.type, this.value);
    playSound("item/pickup", false);

    if (this.type == "Cash")
    {
      dialog("Acquired: £" + this.value, [], 5000);
    }
    else
    {
      dialog("Acquired: " + this.type + " x" + this.value, [], 5000);
    }

    this.collected = true;

    return true;
  }

  return false;
};

Item.prototype.snapToGround = function()
{
  var y = this.room.getGroundYPosition(this.x + this.w / 2);

  this.y = y - this.h + 0.02;
};

Item.prototype.scatter = function(force)
{
  if (this.character != null)
  {
    this.x = this.character.x + (this.character.w - this.w) / 2;
    this.xForce = force;
    this.room = this.character.room;
    this.room.addItem(this);
    this.character = null;
    this.snapToGround();
  }
};

Item.prototype.draw = function(canvas, camera, brightness)
{
  if (this.character == null)
  {
    var bright = this.room.getBrightness(this.x + this.w / 2);

    if (this.sprite != null)
    {
      this.sprite.draw(canvas, this.x, this.y, this.w, this.h, 50, camera, false, bright, bright, bright, 0);
    }
    else
    {
      canvas.ctx.globalAlpha = 1;

      if (this.hFlip)
      {
        canvas.ctx.translate(asWidth(this.x) + asWidth(this.w) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
        canvas.ctx.scale(-1, 1);
        this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
      }
      else
      {
        canvas.ctx.translate(asWidth(this.x) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
        this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
      }

      canvas.ctx.setTransform(1, 0, 0, 1, 0, 0);
    }
  }
};

Item.prototype.toDelete = function()
{
  return this.collected;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Key State  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function KeyState(keyCode)
{
  this.active = false;
  this.previous = false;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Map Locations  ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MapLocations()
{
  this.map = new Map();

  this.setup();
}

MapLocations.prototype.add = function(worldId, x, y, worldDesc, isSideOp, isAvailable)
{
  this.map.set(worldId, new MapPointData(worldId, x, y, worldDesc, isSideOp, isAvailable));
};

MapLocations.prototype.get = function(worldId)
{
  this.map.get(worldId);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Map Point Data ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MapPointData(worldId, x, y, worldDesc, type, isAvailable)
{
  this.worldId = worldId;
  this.x = x;
  this.y = y;
  this.worldDesc = worldDesc;
  this.type = type;
  this.isAvailable = isAvailable;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// Map Screen Point //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MapScreenPoint(worldId, x, y, worldDesc, type)
{
  this.worldId = worldId;
  this.x = x;
  this.y = y;
  this.worldDesc = worldDesc;
  this.type = type;

  this.radius = 0.02;
  this.hoverTxt = this.worldDesc;

  if (worldId == "mb")
  {
    this.r = 0;
    this.g = 0;
    this.b = 0;
  }
  else if (this.type == "Side Op")
  {
    this.r = 255;
    this.g = 255;
    this.b = 0;
  }
  else if (this.type == "Dispatch")
  {
    this.r = 255;
    this.g = 150;
    this.b = 0;
  }
  else
  {
    this.r = 0;
    this.g = 255;
    this.b = 0;
  }
}

MapScreenPoint.prototype.mouseOn = function(mouseX, mouseY)
{
  var x = mouseX - this.x;
  var y = mouseY - this.y;

  return Math.pow(x, 2) + Math.pow(y, 2) < Math.pow(this.radius, 2);
};

MapScreenPoint.prototype.draw = function(canvas)
{
  transparency = (Math.sin(getTime() / 1000) + 1) / 2 - 0.1;

  canvas.colourCircle(this.x, this.y, this.radius, this.r, this.g, this.b, transparency, nullCamera);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Menu Button  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MenuButton(x, y, w, h, r, g, b, fontSize, txt, hoverTxt, func)
{
  this.x = x;
  this.y = y;
  this.w = w;
  this.h = h;
  this.r = r;
  this.g = g;
  this.b = b;
  this.fontSize = fontSize;
  this.txt = txt;
  this.hoverTxt = hoverTxt;
  this.func = func;
}

MenuButton.prototype.mouseOn = function(mouseX, mouseY)
{
  return mouseX > this.x && mouseX < this.x + this.w && mouseY > this.y && mouseY < this.y + this.h;
};

MenuButton.prototype.draw = function(canvas)
{
  canvas.colourRect("rgb(0,0,0)", this.x, this.y, this.w, this.h, nullCamera, 0);

  canvas.ctx.globalAlpha = 1;
  canvas.ctx.fillStyle = "rgb(" + this.r + "," + this.g + "," + this.b + ")";
  canvas.ctx.font = asWidth(this.fontSize) + "px Century Gothic";
  canvas.ctx.fillText(this.txt, asWidth(this.x + 0.05), asHeight(this.y + this.h - this.fontSize / 2));
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Menu Screen  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MenuScreen(canvas)
{
  clearAllSounds();
  playMusic("title screen");

  this.canvas = canvas;

  this.dialogBox = new DialogBox(0.1, 0.7, 0.8, 0.1, this.canvas, 60);
  this.dialogBox2 = new DialogBox(0.1, 0.1, 0.8, 0.1, this.canvas, 60);

  this.birth = getTime();
  this.fadeStart = 0;
  this.fadeTime = 2000;
  this.chosenWorld = "";

  this.home();
}

MenuScreen.prototype.home = function()
{
  this.buttons = [];

  this.addButton(0.1, 0.1, 0.5, 0.08, 200, 100, 50, 0.03, "Live", "Navigate main game menus", this.live.bind(this));
  this.addButton(0.1, 0.2, 0.5, 0.08, 200, 100, 50, 0.03, "Test worlds", "Play a test world", this.testWorlds.bind(this));
  this.addButton(0.1, 0.3, 0.5, 0.08, 200, 100, 50, 0.03, "Sounds on/off", "Alternates sound effects on/off", switchSoundOnOff);
  this.addButton(0.1, 0.4, 0.5, 0.08, 200, 100, 50, 0.03, "Music on/off", "Alternates music on/off", switchMusicOnOff);
  this.addButton(0.1, 0.5, 0.5, 0.08, 200, 100, 50, 0.03, "Controls", "Left/Right: move, Up: interact, Z: melee attack / fire gun, Esc: return to main menu.", function(){});
};

MenuScreen.prototype.live = function()
{
  this.buttons = [];

  this.addButton(0.1, 0.1, 0.5, 0.08, 200, 100, 50, 0.03, "Choose destination", "Go to map screen and choose stage to begin", this.map.bind(this));
  this.addButton(0.1, 0.2, 0.5, 0.08, 200, 100, 50, 0.03, "Resources", "View list of resources, upgrade equipment etc.", this.resources.bind(this));
  this.addButton(0.1, 0.3, 0.5, 0.08, 200, 100, 50, 0.03, "Staff management", "Check current staff", this.staff.bind(this));
  this.addButton(0.1, 0.4, 0.5, 0.08, 200, 100, 50, 0.03, "Back", "", this.home.bind(this));
};

MenuScreen.prototype.goWorld = function(dest)
{
  playSound("guns/shotgun/shoot", false);

  this.chosenWorld = dest;
  this.fadeStart = getTime();
};

MenuScreen.prototype.selectDispatch = function(dest)
{
  this.buttons = [];

  var yes = function()
  {
    this.dispatchResults(game.dispatches.dispatch(dest));
  };

  var no = function()
  {
    this.dialogBox2.reset();
    this.map();
  };

  this.dialogBox2.setDialog(game.dispatches.select(dest) + " \n Do this dispatch mission?", [], 0);

  if (game.dispatches.get(dest).costIsCovered())
  {
    this.addButton(0.1, 0.7, 0.2, 0.08, 200, 100, 50, 0.03, "Yes", "", yes.bind(this));
    this.addButton(0.1, 0.8, 0.2, 0.08, 200, 100, 50, 0.03, "No", "", no.bind(this));
  }
  else
  {
    this.addButton(0.1, 0.7, 0.4, 0.08, 200, 100, 50, 0.03, "Not enough fuel", "", no.bind(this));
  }
};

MenuScreen.prototype.dispatchResults = function(result)
{
  this.buttons = [];

  var continu = function()
  {
    this.dialogBox2.reset();
    this.map();
  };

  this.dialogBox2.setDialog(result, [], 0);

  this.addButton(0.1, 0.7, 0.2, 0.08, 200, 100, 50, 0.03, "Continue", "", continu.bind(this));
};

MenuScreen.prototype.map = function()
{
  this.buttons = [];

  var arr = Array.from(game.mapLocations.map.values());

  for (var i = 0; i < arr.length; i++)
  {
    var v = arr[i];

    if (v.isAvailable())
    {
      this.addMapPoint(v.worldId, v.x, v.y, v.worldDesc, v.type);
    }
  }

  this.addDispatchPoints();

  this.addButton(0.1, 0.61, 0.5, 0.08, 200, 100, 50, 0.03, "Back", "", this.live.bind(this));
};

MenuScreen.prototype.addMapPoint = function(worldId, x, y, worldDesc, type)
{
  var b = new MapScreenPoint(worldId, 0.1 + x * 0.8, 0.1 + y * 0.5, worldDesc, type);
  b.func = this.goWorld.bind(this, b.worldId);

  this.buttons.push(b);
};

MenuScreen.prototype.addDispatchPoints = function()
{
  var arr = Array.from(game.dispatches.map.values());

  for (var i = 0; i < arr.length; i++)
  {
    var d = arr[i];

    if (d.isAvailable())
    {
      this.addDispatchPoint(d.id, d.x, d.y, d.getHoverTxt());
    }
  }
};

MenuScreen.prototype.addDispatchPoint = function(dispatchId, x, y, desc)
{
  var b = new MapScreenPoint(dispatchId, 0.1 + x * 0.8, 0.1 + y * 0.5, desc, "Dispatch");
  b.func = this.selectDispatch.bind(this, b.worldId);

  this.buttons.push(b);
};

MenuScreen.prototype.resources = function()
{
  this.buttons = [];

  this.addButton(0.01, 0.1, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Cash").toString(), "Invest in " + baseName + " features and new buildings", function(){});
  this.addButton(0.51, 0.1, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Fuel").toString(), "Allows for dispatch missions to occur more frequently", function(){});
  this.addButton(0.01, 0.2, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Metal").toString(), "Used for basic weapon upgrades", function(){});
  this.addButton(0.51, 0.2, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Wood").toString(), "Used as part of new buildings at " + baseName, function(){});
  this.addButton(0.01, 0.3, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Special Materials").toString(), "Special components needed for developing advanced weapons/items", function(){});
  this.addButton(0.51, 0.3, 0.48, 0.08, 200, 100, 50, 0.03, game.inventory.get("Food").toString(), "Eat healthy meals to increase the max hp of " + playerName, function(){});
  this.addButton(0.1, 0.4, 0.5, 0.08, 200, 100, 50, 0.03, "Back", "", this.live.bind(this));
};

MenuScreen.prototype.staff = function()
{
  this.buttons = [];

  var map = game.motherBase.getSkillLevelMap();

  if (map.size > 0)
  {
    this.addButton(0.01, 0.1, 0.48, 0.08, 200, 100, 50, 0.03, "Soldier: Lvl " + map.get("Soldier").getLevel(), "Determines the strength of your combat team for dispatch missions", function(){});
    this.addButton(0.51, 0.1, 0.48, 0.08, 200, 100, 50, 0.03, "Research: Lvl " + map.get("Research").getLevel(), "A higher research level offers more weapon development and upgrades", function(){});
    this.addButton(0.01, 0.2, 0.48, 0.08, 200, 100, 50, 0.03, "Construction: Lvl " + map.get("Construction").getLevel(), "With a high construction level you can build more advanced structures", function(){});
    this.addButton(0.51, 0.2, 0.48, 0.08, 200, 100, 50, 0.03, "Intel: Lvl " + map.get("Intel").getLevel(), "Your team's overall ability to gather intel to assist with missions", function(){});
    this.addButton(0.01, 0.3, 0.48, 0.08, 200, 100, 50, 0.03, "Medic: Lvl " + map.get("Medic").getLevel(), "Reduces the number of casualties in dispatch missions and improves overall staff health", function(){});
    this.addButton(0.51, 0.3, 0.48, 0.08, 200, 100, 50, 0.03, "Total Staff: " + game.motherBase.getStaffCount(), "", function(){});
  }
  else
  {
    this.addButton(0.1, 0.1, 0.5, 0.08, 200, 100, 50, 0.03, "No Staff", "", function(){});
  }

  this.addButton(0.1, 0.4, 0.5, 0.08, 200, 100, 50, 0.03, "Back", "", this.live.bind(this));
};

MenuScreen.prototype.testWorlds = function()
{
  this.buttons = [];

  this.addButton(0.1, 0.1, 0.5, 0.08, 200, 100, 50, 0.03, "Test world 1", "Feed the ducks", this.goWorld.bind(this, "tw1"));
  this.addButton(0.1, 0.2, 0.5, 0.08, 200, 100, 50, 0.03, "Test world 2", "Feed the pigs", this.goWorld.bind(this, "tw2"));
  this.addButton(0.1, 0.3, 0.5, 0.08, 200, 100, 50, 0.03, "Test world 3", "Feed the fish", this.goWorld.bind(this, "tw3"));
  this.addButton(0.1, 0.4, 0.5, 0.08, 200, 100, 50, 0.03, "Back", "", this.home.bind(this));
};

MenuScreen.prototype.addButton = function(x, y, w, h, r, g, b, fontSize, txt, hoverTxt, func)
{
  var b = new MenuButton(x, y, w, h, r, g, b, fontSize, txt, hoverTxt, func);

  this.buttons.push(b);
};

MenuScreen.prototype.doTime = function()
{
  this.checkMusic();
  this.draw();

  if (this.chosenWorld != "" && getTime() > this.fadeStart + this.fadeTime) {game.enterWorld(this.chosenWorld);}
};

MenuScreen.prototype.getFade = function()
{
  if (this.fadeStart != 0) {return Math.min(Math.max((getTime() - this.fadeStart) / this.fadeTime, 0), 1);}

  return 0;
};

MenuScreen.prototype.checkMusic = function()
{
  var vol = 1;
  if (this.death != 0) {vol = 1 - this.getFade();}

  soundController.setFadeVolume(vol);
};

MenuScreen.prototype.setDialog = function(txt)
{
  this.dialogBox.setDialog(txt, [], 0);
};

MenuScreen.prototype.draw = function()
{
  this.canvas.reset();

  this.drawBackground();
  this.drawAnimation();
  this.drawMap();
  this.drawButtons();
  this.drawDialogBox();
  this.drawFade();
};

MenuScreen.prototype.drawFade = function()
{
  this.canvas.colourRect("rgb(0,0,0)", 0, 0, 1, 1, nullCamera, 1 - this.getFade());
};

MenuScreen.prototype.drawButtons = function()
{
  for (var i = 0; i < this.buttons.length; i++)
  {
    this.buttons[i].draw(this.canvas);
  }
};

MenuScreen.prototype.drawMap = function()
{
  if (this.buttons.length > 0 && typeof this.buttons[0].worldId != "undefined")
  {
    this.canvas.drawImage(getImage("world map/plain/0"), 0.1, 0.1, 0.8, 0.5, false, nullCamera, 0);
  }
};

MenuScreen.prototype.drawAnimation = function()
{
  
};

MenuScreen.prototype.drawBackground = function()
{
  var t = (getTime() - this.birth) / 10000;
  var r = Math.round((Math.sin(t) + 1) * 50 + 50);
  var g = Math.round((Math.sin(t + 1) + 1) * 10 + 50);
  var b = Math.round((Math.sin(t + 2) + 1) * 30 + 50);

  this.canvas.colourRect("rgb(" + r + "," + g + "," + b + ")", 0, 0, 1, 1, nullCamera, 0);
};

MenuScreen.prototype.drawDialogBox = function()
{
  this.dialogBox.draw();
  this.dialogBox2.draw();
};

MenuScreen.prototype.click = function(e)
{
  if (this.chosenWorld == "")
  {
    var b = this.getPointedButton(e);

    if (b != null) {this.setDialog(""); b.func();}
    else {playSound("guns/handgun/pickup", false);}
  }
};

MenuScreen.prototype.mousemove = function(e)
{
  if (this.chosenWorld == "")
  {
    var b = this.getPointedButton(e);

    if (b != null) {this.setDialog(b.hoverTxt);}
    else {this.setDialog("");}
  }
};

MenuScreen.prototype.getPointedButton = function(e)
{
  var x = e.clientX / asWidth(1);
  var y = e.clientY / asHeight(1);

  for (var i = 0; i < this.buttons.length; i++)
  {
    if (this.buttons[i].mouseOn(x, y))
    {
      return this.buttons[i];
    }
  }

  return null;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////// Mission Status Map /////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MissionStatusMap()
{
  this.map = new Map();
}

MissionStatusMap.prototype.get = function(id)
{
  return this.map.get(id);
};

MissionStatusMap.prototype.set = function(id, state)
{
  this.map.set(id, new MissionStatus(id, state));
};

MissionStatusMap.prototype.registerComplete = function(id)
{
  this.set(id, "complete");
};

MissionStatusMap.prototype.missionIsComplete = function(id)
{
  var x = this.map.get(id);

  return x != null && x.isComplete();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Mission Status ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MissionStatus(id, state)
{
  this.id = id;
  this.state = state;
}

MissionStatus.prototype.isComplete = function()
{
  return this.state == "complete";
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Mother Base  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function MotherBase()
{
  this.charMap = new Map();
  this.creations = 0;
}

MotherBase.prototype.addStaff = function(char)
{
  if (char.skillSet != null)
  {
    char.skillSet.id = this.creations++;
    this.charMap.set(char.skillSet.id, char.skillSet);
  }
};

MotherBase.prototype.removeStaff = function(char)
{
  if (char.skillSet != null)
  {
    this.charMap.delete(char.skillSet.id);
  }
};

MotherBase.prototype.removeNumberOfStaff = function(amount)
{
  for (var i = 0; i < amount; i++)
  {
    this.removeFirstStaffMember();
  }
};

MotherBase.prototype.removeFirstStaffMember = function()
{
  if (this.charMap.size > 0)
  {
    var id = Array.from(this.charMap.values())[0].id;

    this.charMap.delete(id);
  }
};

MotherBase.prototype.getSkillLevelMap = function()
{
  var skillMap = new Map();
  var arr = Array.from(this.charMap.values());

  var getLevelFunc = function()
  {
    return Math.round(Math.pow(this.points, 0.5));
  };

  for (var i = 0; i < arr.length; i++)
  {
    var keys = Array.from(arr[i].skillMap.keys());

    for (var j = 0; j < keys.length; j++)
    {
      if (!skillMap.has(keys[j])) {skillMap.set(keys[j], {skillId: keys[j], points: 0, getLevel: getLevelFunc});}

      skillMap.get(keys[j]).points += arr[i].getSkillValue(keys[j]);
    }
  }

  return skillMap;
};

MotherBase.prototype.getSkillLevels = function()
{
  var arr = Array.from(this.getSkillLevelMap().values());
  var s = "";

  for (var i = 0; i < arr.length; i++)
  {
    if (i > 0) {s = s + " \n ";}
    s = s + arr[i].skillId + ": Lvl " + arr[i].getLevel();
  }

  return s;
};

MotherBase.prototype.getSkillLevel = function(skillId)
{
  var skillMap = this.getSkillLevelMap();

  if (skillMap.has(skillId))
  {
    return skillMap.get(skillId).getLevel();
  }

  return 0;
};

MotherBase.prototype.getStaffCount = function()
{
  return this.charMap.size;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// Opening Scene  ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function OpeningScene(canvas)
{
  clearAllSounds();
  playMusic("6");

  this.canvas = canvas;

  this.dialogBox = new DialogBox(0.1, 0.1, 0.8, 0.1, this.canvas, 60, 1);
  this.dialogBox.setDialog("The weird and wonderful world of Biehn seems rather peaceful on the surface. " +
    "The native race of Zai occupy this small planet, and all inhabitants work together to achieve the goals of their leaders. " +
    "You were once such a leader, but your rank was taken from you for reasons that you and the script writers have forgotten about. " +
    "Find your allies, build an army, and take out the world leaders to become the sole ruler over the planet!", [], 0);

  this.birth = getTime();
  this.fadeStart = 0;
  this.fadeTime = 5000;
}

OpeningScene.prototype.doTime = function()
{
  this.checkMusic();
  this.draw();
};

OpeningScene.prototype.getFade = function()
{
  if (this.fadeStart != 0) {return Math.min(Math.max((getTime() - this.fadeStart) / this.fadeTime, 0), 1);}

  return 0;
};

OpeningScene.prototype.checkMusic = function()
{
  var vol = 1;
  if (this.fadeStart != 0) {vol = 1 - this.getFade();}

  soundController.setFadeVolume(vol);
};

OpeningScene.prototype.draw = function()
{
  this.canvas.reset();

  this.drawBackground();
  this.drawDialogBox();
  this.drawFade();
};

OpeningScene.prototype.drawFade = function()
{
  var fade = this.getFade();

  this.canvas.colourRect("rgb(0,0,0)", 0, 0, 1, 1, nullCamera, 1 - fade);

  if (fade == 1) {game.enterMenu();}
};

OpeningScene.prototype.drawDialogBox = function()
{
  var scroll = (this.birth - getTime()) / 10000 + 1;

  this.dialogBox.y = scroll;

  this.dialogBox.draw();

  if (scroll < 0 && this.fadeStart == 0) {this.fadeStart = getTime();}
};

OpeningScene.prototype.drawBackground = function()
{
  this.canvas.colourRect("rgb(0, 0, 0)", 0, 0, 1, 1, nullCamera, 0);
};

OpeningScene.prototype.click = function(e)
{
  if (this.fadeStart == 0) {this.fadeTime = 2000; this.fadeStart = getTime();}
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// Particle //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Particle(room, x, y, radius, xSpeed, ySpeed, r, g, b, fadeOutTime)
{
  this.room = room;
  this.x = x;
  this.y = y;
  this.radius = radius;
  this.xSpeed = xSpeed;
  this.ySpeed = ySpeed;
  this.r = r;
  this.g = g;
  this.b = b;
  this.fadeOutTime = fadeOutTime;

  this.birth = getTime();
}

Particle.prototype.doTime = function()
{
  this.x += this.xSpeed;
  this.y += this.ySpeed;
  this.radius /= 1.1;
};

Particle.prototype.draw = function(canvas, camera)
{
  var bright = this.room.getBrightness(this.x);
  var r = this.r * bright;
  var g = this.g * bright;
  var b = this.b * bright;

  var transparency = 0;
  if (this.fadeOutTime != 0) {transparency = (getTime() - this.birth) / this.fadeOutTime;}

  canvas.colourCircle(this.x, this.y, this.radius, r, g, b, transparency, camera)
};

Particle.prototype.toDelete = function()
{
  if (this.fadeOutTime != 0)
  {
    return getTime() > this.birth + this.fadeOutTime;
  }

  return false;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Patrol Route ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function PatrolRoute(steps)
{
  this.steps = steps;
  this.index = 0;
}

PatrolRoute.prototype.getMoveDirection = function(x)
{
  if (this.steps.length > 0)
  {
    this.checkStep(x);

    return this.steps[this.index].getMoveDirection(x);
  }

  return 0;
};

PatrolRoute.prototype.checkStep = function(x)
{
  if (this.steps.length > 0 && this.steps[this.index].isDone(x))
  {
    this.index = (this.index + 1) % this.steps.length;
    this.steps[this.index].start(x);
  }
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Patrol Step  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function PatrolStep(targetX)
{
  this.targetX = targetX;

  this.started = false;
}

PatrolStep.prototype.start = function(x)
{
  this.goLeft = (x > this.targetX);

  this.started = true;
};

PatrolStep.prototype.isDone = function(x)
{
  if (!this.started) {this.start();}

  return this.goLeft && x < this.targetX || !this.goLeft && x > this.targetX;
};

PatrolStep.prototype.getMoveDirection = function(x)
{
  return this.goLeft ? -1 : 1;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Point  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Point(x, y)
{
  this.x = x;
  this.y = y;
}

Point.prototype.rotateAbout = function(centreX, centreY, rotation)
{
  var p = new Point(this.x - centreX, this.y - centreY);

  var x = p.x * Math.cos(rotation) - p.y * Math.sin(rotation);
  var y = p.x * Math.sin(rotation) + p.y * Math.cos(rotation);

  p.x = x + centreX;
  p.y = y + centreY;

  return p;
};

Point.prototype.translate = function(x, y)
{
  return new Point(this.x + x, this.y + y);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Projectile /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Projectile(attacker, room, x, y, range, aimLeft, hitsPlayer, hitsEnemy, type)
{
  this.attacker = attacker;
  this.room = room;
  this.x = x;
  this.y = y;
  this.range = range;
  this.aimLeft = aimLeft;
  this.hitsPlayer = hitsPlayer;
  this.hitsEnemy = hitsEnemy;
  this.type = type;
  if (this.type == "flame") {this.sprite = new Sprite("flame thrower", "flame");}

  this.birth = getTime();
}

Projectile.prototype.draw = function(canvas, camera)
{
  var bright = this.room.world.getFade() * 255;

  if (this.type == "flame")
  {
    this.sprite.checkFrame(100);

    var p = this.sprite.getHandlePoint("tip");
    var w = this.range;
    var h = 0.1;
    var x;
    var y = this.y - p.y * h;
    
    if (this.aimLeft)
    {
      x = this.x - w + p.x;
    }
    else
    {
      x = this.x - p.x;
    }

    this.sprite.justDraw(canvas, x, y, w, h, camera, this.aimLeft, bright, bright, bright, (getTime() - this.birth) / 800);
  }
  else
  {
    this.drawCone(canvas.ctx, camera, (getTime() - this.birth) / 200 * this.range, (getTime() - this.birth) / 200);
  }
};

Projectile.prototype.drawCone = function(ctx, camera, size, transparency)
{
  var dir = 1;
  if (this.aimLeft) {dir = -1;}
  var sqr = Math.sqrt(0.5) * size * dir;

  ctx.globalAlpha = 1 - transparency;
  ctx.translate(-asWidth(camera.x), -asHeight(camera.y));
  ctx.fillStyle = "#ccffaa";
  ctx.beginPath();

  ctx.moveTo(asWidth(this.x + sqr), asHeight(this.y - size));
  ctx.bezierCurveTo(asWidth(this.x + size * dir), asHeight(this.y), asWidth(this.x + size * dir), asHeight(this.y), asWidth(this.x + sqr), asHeight(this.y + size));
  ctx.bezierCurveTo(asWidth(this.x), asHeight(this.y), asWidth(this.x), asHeight(this.y), asWidth(this.x + sqr), asHeight(this.y - size));

  ctx.closePath();
  ctx.fill();
  ctx.setTransform(1, 0, 0, 1, 0, 0);
};

Projectile.prototype.getX1 = function()
{
  if (this.aimLeft) {return this.x - this.range;}
  else {return this.x;}
};

Projectile.prototype.getX2 = function()
{
  if (this.aimLeft) {return this.x;}
  else {return this.x + this.range;}
};

Projectile.prototype.toDelete = function()
{
  if (this.type == "flame") {return getTime() > this.birth + 800;}
  else {return getTime() > this.birth + 200;}
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// Rgb  ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Rgb(r, g, b)
{
  this.r = r;
  this.g = g;
  this.b = b;
}

Rgb.prototype.adjustBrightness = function(brightness)
{
  return new Rgb(this.r * brightness, this.g * brightness, this.b * brightness);
};

Rgb.prototype.multiply = function(r, g, b)
{
  return new Rgb(this.r * r, this.g * g, this.b * b);
};

Rgb.prototype.toString = function()
{
  return "rgb(" + Math.round(this.r) + ", " + Math.round(this.g) + ", " + Math.round(this.b) + ")";
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// Room ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Room(id, world, stageWidth, brightness, groundPoints, groundPattern, groundR, groundG, groundB, backgroundPattern, backgroundR, backgroundG, backgroundB, musicName)
{
  this.id = id;
  this.world = world;
  this.stageWidth = stageWidth;
  this.brightness = brightness;
  this.groundPoints = groundPoints;
  this.groundPattern = groundPattern;
  this.groundR = groundR;
  this.groundG = groundG;
  this.groundB = groundB;
  this.backgroundPattern = backgroundPattern;
  this.backgroundR = backgroundR;
  this.backgroundG = backgroundG;
  this.backgroundB = backgroundB;
  this.musicName = musicName;
  this.structures = [];
  this.characters = [];
  this.guns = [];
  this.items = [];
  this.bloodDrops = [];
  this.knifedCharacter = null;

  this.world.addRoom(this);

  this.projectiles = null;
  this.entryTime = 0;
}

Room.prototype.addCharacter = function(c)
{
  this.characters.push(c);
};

Room.prototype.addStructure = function(s)
{
  this.structures.push(s);
};

Room.prototype.addGun = function(g)
{
  this.guns.push(g);
};

Room.prototype.addItem = function(i)
{
  this.items.push(i);
};

Room.prototype.enter = function()
{
  this.projectiles = [];
  this.entryTime = getTime();

  clearAllSounds();

  playMusic(this.musicName);
};

Room.prototype.doTime = function(active)
{
  if (active)
  {
    doTimeArray(this.characters);
    this.world.player.doTime();
    doTimeArray(this.structures);
    doTimeArray(this.guns);
    doTimeArray(this.items);
    doTimeArray(this.bloodDrops);

    this.checkKnifedCharacter();

    if (this.world.stageStarted) {this.checkCollisions();}
  }

  this.checkCamera();
  this.draw();
};

Room.prototype.allThreatsNeutralised = function()
{
  for (var i = 0; i < this.characters.length; i++)
  {
    if (this.characters[i].isThreat()) {return false;}
  }

  return true;
};

Room.prototype.getById = function(id)
{
  var obj = arrayGetById(this.characters, id);
  if (obj != null) {return obj;}

  obj = arrayGetById(this.items, id);
  if (obj != null) {return obj;}

  obj = arrayGetById(this.structures, id);
  if (obj != null) {return obj;}

  obj = arrayGetById(this.guns, id);
  if (obj != null) {return obj;}

  return null;
};

Room.prototype.containsId = function(id)
{
  return this.getById(id) != null;
};

Room.prototype.checkCollisions = function()
{
  for (var i = 0; i < this.items.length; i++)
  {
    if (this.items[i].collides(this.world.player))
    {
      this.world.player.collectItem(this.items[i]);
    }
  }
};

Room.prototype.tryInteract = function(x)
{
  var b = false;
  for (var i = this.guns.length - 1; i >= 0 && !b; i--)
  {
    b = this.guns[i].tryInteract(x);
  }

  for (var i = this.characters.length - 1; i >= 0 && !b; i--)
  {
    b = this.characters[i].tryInteract(x);
  }

  for (var i = this.structures.length - 1; i >= 0 && !b; i--)
  {
    b = this.structures[i].tryInteract(x);
  }
};

Room.prototype.getCharacterInMeleeRange = function(char)
{
  for (var i = this.characters.length - 1; i >= 0; i--)
  {
    var c = this.characters[i];

    if (!c.isDead() && !c.isBurning() && !c.rescued &&
      (!char.hFlip && char.x + char.w > c.x && char.x + char.w < c.x + c.w * 0.7 ||
      char.hFlip && char.x < c.x + c.w && char.x > c.x + c.w * 0.3))
    {
      return c;
    }
  }

  return null;
};

Room.prototype.checkWitnesses = function(char)
{
  for (var i = this.characters.length - 1; i >= 0; i--)
  {
    this.characters[i].checkAsWitness(char);
  }
};

Room.prototype.setKnifedCharacter = function(char)
{
  this.knifedCharacter = char;

  if (char != null) {playSound("knife/stab", false);}
};

Room.prototype.checkCamera = function()
{
  var x = this.world.player.x + this.world.player.w / 2 - 0.5;
  x = Math.min(Math.max(x, 0), this.stageWidth - 1);

  this.world.camera.setX(x);
};

Room.prototype.fireProjectile = function(attacker, x, y, aimLeft, damage, range, shotForce, burn, hitsPlayer, hitsEnemy, type)
{
  var p = new Projectile(attacker, this, x, y, range, aimLeft, hitsPlayer, hitsEnemy, type);
  this.projectiles.push(p);

  if (p.hitsEnemy)
  {
    for (var i = this.characters.length - 1; i >= 0; i--)
    {
      if (this.characters[i].x + this.characters[i].w > p.getX1() && this.characters[i].x < p.getX2())
      {
        this.characters[i].hit(attacker, aimLeft, damage, shotForce, burn, type);
      }
    }
  }

  if (p.hitsPlayer)
  {
    if (this.world.player.x + this.world.player.w > p.getX1() && this.world.player.x < p.getX2())
    {
      this.world.player.hit(attacker, aimLeft, damage, shotForce, burn, type);
    }
  }

  if (type == "flame")
  {
    for (var i = this.structures.length - 1; i >= 0; i--)
    {
      if (this.structures[i].x + this.structures[i].w > p.getX1() && this.structures[i].x < p.getX2())
      {
        this.structures[i].setOnFire();
      }
    }
  }
};

Room.prototype.checkKnifedCharacter = function()
{
  if (this.knifedCharacter != null)
  {
    this.addBloodSplat(this.knifedCharacter.x + this.knifedCharacter.w / 2, this.knifedCharacter.y + this.knifedCharacter.h / 2,
      Math.random() < 0.5, Math.random() * 0.005, Math.random() * 5 + 1);
  }
};

Room.prototype.releaseKnifedCharacter = function()
{
  this.addBloodSplat(this.knifedCharacter.x + this.knifedCharacter.w / 2, this.knifedCharacter.y + this.knifedCharacter.h / 2,
      true, Math.random() * 0.008, Math.random() * 5 + 10);

  this.addBloodSplat(this.knifedCharacter.x + this.knifedCharacter.w / 2, this.knifedCharacter.y + this.knifedCharacter.h / 2,
      false, Math.random() * 0.008, Math.random() * 5 + 10);

 playSound("knife/remove", false);
};

Room.prototype.addBloodSplat = function(x, y, left, force, numOfParticles)
{
  var dir = left ? -1 : 1;

  for (var i = 0; i < numOfParticles; i++)
  {
    var radius = Math.random() * 0.005 + 0.005;
    var xSpeed = (Math.random() + 1) * force * dir;
    var ySpeed = -(Math.random() + 1) * force;

    this.addBloodParticle(x, y, radius, xSpeed, ySpeed);
  }
};

Room.prototype.addBloodParticle = function(x, y, radius, xSpeed, ySpeed)
{
  var p = new Particle(this, x, y, radius, xSpeed, ySpeed, 0.7, 0, 0, 2000);

  this.bloodDrops.push(p);
};

Room.prototype.getGroundYPosition = function(x)
{
  for (var i = 0; i < this.groundPoints.length - 1; i++)
  {
    if (x >= this.groundPoints[i].x && x < this.groundPoints[i + 1].x)
    {
      var fraction = (x - this.groundPoints[i].x) / (this.groundPoints[i + 1].x - this.groundPoints[i].x);

      return this.groundPoints[i].y + (this.groundPoints[i + 1].y - this.groundPoints[i].y) * fraction;
    }
  }

  return 1;
};

Room.prototype.getBaseBrightness = function()
{
  return this.brightness;
};

Room.prototype.getBrightness = function(x)
{
  var shadow = 0;

  for (var i = 0; i < this.structures.length; i++)
  {
    shadow = Math.max(shadow, this.structures[i].getShadowIntensity(x));
  }

  return (this.getBaseBrightness() - shadow) * 255;
};

Room.prototype.getRoomShadow = function()
{
  return (1 - this.getBaseBrightness()) * 255;
};

Room.prototype.draw = function()
{
  this.world.canvas.reset();

  this.drawBackground();
  this.drawCharactersBackground();
  this.drawStructures();
  this.drawGround();
  this.drawCharactersForeground();
  this.drawGuns();
  this.drawItems();
  this.world.drawPlayer();
  this.drawKnifedCharacter();
  if (this.knifedCharacter != null) {this.world.player.drawKnife(this.world.canvas, this.world.camera);}
  this.drawBloodDrops();

  this.drawRoomShadow();
  this.drawStructuresLight();
  this.drawCharactersLight();
  this.world.drawPlayerLight();
  this.drawProjectiles();

  if (this.world.stageStarted) {this.world.drawHud();}
  else {this.world.drawCountdown();}

  this.world.drawDialogBox();
  this.drawFade();
  this.world.drawMissionEnd();
};

Room.prototype.drawFade = function()
{
  this.world.canvas.colourRect("rgb(0,0,0)", 0, 0, 1, 1, nullCamera, this.world.getFade());
};

Room.prototype.drawRoomShadow = function()
{
  this.world.canvas.colourRect("rgb(0,0,0)", 0, 0, 1, 1, nullCamera, this.getBaseBrightness());
};

Room.prototype.drawProjectiles = function()
{
  garbageAndDraw(this.projectiles, this.world.canvas, this.world.camera);
};

Room.prototype.drawGuns = function()
{
  garbageAndDraw(this.guns, this.world.canvas, this.world.camera);
};

Room.prototype.drawItems = function()
{
  garbageAndDraw(this.items, this.world.canvas, this.world.camera);
};

Room.prototype.drawBloodDrops = function()
{
  garbageAndDraw(this.bloodDrops, this.world.canvas, this.world.camera);
};

Room.prototype.drawKnifedCharacter = function()
{
  drawKnifedArray(this.characters, this.world.canvas, this.world.camera);
};

Room.prototype.drawCharactersForeground = function()
{
  garbageCollectArray(this.characters);
  drawForegroundArray(this.characters, this.world.canvas, this.world.camera);
};

Room.prototype.drawCharactersBackground = function()
{
  garbageCollectArray(this.characters);
  drawBackgroundArray(this.characters, this.world.canvas, this.world.camera);
};

Room.prototype.drawStructures = function()
{
  drawArray(this.structures, this.world.canvas, this.world.camera);
};

Room.prototype.drawCharactersLight = function()
{
  drawLightArray(this.characters, this.world.canvas, this.world.camera);
};

Room.prototype.drawStructuresLight = function()
{
  drawLightArray(this.structures, this.world.canvas, this.world.camera);
};

Room.prototype.drawGround = function()
{
  var arr = this.groundPoints.slice(0);
  arr.push(new Point(this.stageWidth, 1));
  arr.push(new Point(0, 1));

  if (this.groundPattern == null || this.groundPattern.animationId == "")
  {
    var r = Math.round(this.groundR);
    var g = Math.round(this.groundG);
    var b = Math.round(this.groundB);

    this.world.canvas.colourPolygon("rgb(" + r + "," + g + "," + b + ")", arr, this.world.camera, 0);
  }
  else
  {
    var bright = 255;
    this.groundPattern.checkFrame(10000);
    var pattern = this.groundPattern.getImage(bright, bright, bright);

    this.world.canvas.patternPolygon(pattern, arr, this.world.camera, "repeat", 0);
  }
};

Room.prototype.drawBackground = function()
{
  if (this.backgroundPattern == null || this.backgroundPattern.animationId == "")
  {
    var r = Math.round(this.backgroundR);
    var g = Math.round(this.backgroundG);
    var b = Math.round(this.backgroundB);

    //this.world.canvas.colourRect("rgb(" + r + "," + g + "," + b + ")", 0, 0, this.stageWidth, 1, this.world.camera, 0);

    this.world.canvas.ctx.translate(-asWidth(this.world.camera.x), -asHeight(this.world.camera.y));

    this.sketchClouds(this.world.canvas.ctx, asWidth(this.stageWidth), asHeight(1), this.getBaseBrightness(), new Rgb(r, g, b), new Rgb(200, 200, 200));

    this.world.canvas.ctx.setTransform(1, 0, 0, 1, 0, 0);
  }
  else
  {
    var bright = 255;
    this.backgroundPattern.checkFrame(10000);
    var pattern = this.backgroundPattern.getImage(bright, bright, bright);

    this.world.canvas.patternRect(pattern, 0, 0, this.stageWidth, 1, this.world.camera, "repeat", 0);
  }
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// Sound Controller //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function SoundController()
{
  this.sounds = [];
  this.music = null;
  this.soundMasterVolume = 0;
  this.musicMasterVolume = 0;
  this.fadeVolume = 1;

  this.setupTracks();
}

SoundController.prototype.setupTracks = function()
{
  this.tracks = new Map();

  this.addMusic("0", true);
  this.addMusic("1", true);
  this.addMusic("2", true);
  this.addMusic("3", true);
  this.addMusic("4", true);
  this.addMusic("5", true);
  this.addMusic("6", true);
  this.addMusic("title screen", true);
  this.addMusic("mb", true);
  this.addMusic("mission complete", false);
  this.addMusic("game over", false);
};

SoundController.prototype.doTime = function()
{
  garbageCollectArray(this.sounds);
};

SoundController.prototype.addSound = function(soundFile, loop)
{
  var s = new Sound(this, soundFile, false, loop);
  this.sounds.push(s);

  return s;
};

SoundController.prototype.addMusic = function(trackName, loop)
{
  var s = new Sound(this, "music/" + trackName, true, loop);
  this.tracks.set(trackName, s);

  return s;
};

SoundController.prototype.setMusic = function(trackName)
{
  var track = this.tracks.get(trackName);

  if (this.music != null) {this.music.stop();}

  this.music = track;
  this.music.play();
};

SoundController.prototype.setFadeVolume = function(v)
{
  this.fadeVolume = v;

  this.resetVolume();
};

SoundController.prototype.resetVolume = function()
{
  for (var i = 0; i < this.sounds.length; i++)
  {
    this.sounds[i].resetVolume();
  }

  if (this.music != null) {this.music.resetVolume();}
};

SoundController.prototype.pauseAll = function()
{
  for (var i = 0; i < this.sounds.length; i++)
  {
    this.sounds[i].stop();
  }

  if (this.music != null) {this.music.stop();}
};

SoundController.prototype.unpauseAll = function()
{
  for (var i = 0; i < this.sounds.length; i++)
  {
    this.sounds[i].unpause();
  }

  if (this.music != null) {this.music.unpause();}
};

SoundController.prototype.clearAll = function()
{
  this.pauseAll();

  this.sounds = [];
  this.music = null;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Sound  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Sound(soundController, soundFile, asMusic, loop)
{
  this.soundController = soundController;
  this.soundFile = soundFile;
  this.asMusic = asMusic;
  this.audio = new Audio(getSrc("sounds/" + this.soundFile + ".mp3"));
  this.setLoop(loop);
  this.setVolume(1);
  this.toTrash = false;
}

Sound.prototype.play = function()
{
  this.audio.currentTime = 0;
  this.audio.play();
};

Sound.prototype.stop = function()
{
  this.audio.pause();
};

Sound.prototype.unpause = function()
{
  if (this.audio.paused) {this.audio.play();}
};

Sound.prototype.endLoop = function()
{
  this.setLoop(false);
};

Sound.prototype.setLoop = function(b)
{
  this.loop = b;
  this.audio.loop = this.loop;
};

Sound.prototype.setVolume = function(v)
{
  this.volume = v;
  this.resetVolume();
};

Sound.prototype.resetVolume = function()
{
  this.audio.volume = this.volume * this.getMasterVolume();
};

Sound.prototype.getMasterVolume = function()
{
  if (this.asMusic)
  {
    return this.soundController.musicMasterVolume * this.soundController.fadeVolume;
  }
  else
  {
    return this.soundController.soundMasterVolume * this.soundController.fadeVolume;
  }
};

Sound.prototype.trash = function()
{
  this.toTrash = true;
};

Sound.prototype.toDelete = function()
{
  if (this.toTrash || !this.loop && this.audio.ended)
  {
    this.stop();
    return true;
  }

  return false;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// Sprite Data  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function SpriteData(imageName, handlePoints)
{
  this.imageLoaded = false;
  this.original = new Image();
  this.original.src = getSrc("images/" + imageName + ".png");

  this.original.onload = this.loadEvent.bind(this);

  this.handlePoints = handlePoints;

  this.tintMap = new Map();
  this.tintArrayDivisor = 5;
}

SpriteData.prototype.loadEvent = function()
{
  this.canvas = document.createElement("canvas");
  this.canvas.width = this.original.width;
  this.canvas.height = this.original.height;
  this.ctx = this.canvas.getContext("2d");
  this.imageLoaded = true;
};

SpriteData.prototype.getTintedImage = function(red, green, blue)
{
  var r = Math.round(Math.min(Math.max(red / this.tintArrayDivisor, 0), 255));
  var g = Math.round(Math.min(Math.max(green / this.tintArrayDivisor, 0), 255));
  var b = Math.round(Math.min(Math.max(blue / this.tintArrayDivisor, 0), 255));

  var tintMapId = r + "," + g + "," + b;

  r = Math.round(r * this.tintArrayDivisor);
  g = Math.round(g * this.tintArrayDivisor);
  b = Math.round(b * this.tintArrayDivisor);

  if (this.imageLoaded)
  {
    if (r > 250 && g > 250 && b > 250)
    {
      return this.original;
    }
    else if (this.tintMap.has(tintMapId))
    {
      return this.tintMap.get(tintMapId);
    }
    else
    {
      var canvas = document.createElement("canvas");
      canvas.width = this.original.width;
      canvas.height = this.original.height;
      var ctx = canvas.getContext("2d");

      ctx.globalCompositeOperation = "darken";
      ctx.fillStyle = "rgb(" + r + ", " + g + ", " + b + ")";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(this.original, 0, 0);
      ctx.globalCompositeOperation = "destination-in";
      ctx.drawImage(this.original, 0, 0);

      this.tintMap.set(tintMapId, canvas);

      return canvas;
    }
  }

  return blankCanvas;
};

SpriteData.prototype.getHandlePoint = function(id)
{
  if (this.handlePoints.has(id))
  {
    return this.handlePoints.get(id);
  }

  return null;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////// Sprite Handle Point  ////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function SpriteHandlePoint(id, p)
{
  this.id = id;
  this.point = p;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Sprite ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Sprite(spriteId, initialAnimation)
{
  this.spriteId = spriteId;
  this.setAnimation(initialAnimation);
}

Sprite.prototype.setSpriteId = function(id)
{
  this.spriteId = id;
};

Sprite.prototype.ensureAnimation = function(animationId)
{
  if (this.animationId != animationId)
  {
    this.animationId = animationId;
    this.setFrameIndex(0);
  }
};

Sprite.prototype.setAnimation = function(animationId)
{
  this.animationId = animationId;
  this.setFrameIndex(0);
};

Sprite.prototype.checkFrame = function(animationDelay)
{
  if (getTime() > this.lastFrame + animationDelay)
  {
    this.nextFrameIndex();
  }
};

Sprite.prototype.nextFrameIndex = function()
{
  this.frameIndex++;

  if (!imageExists(this.getImageId())) {this.frameIndex = 0;}

  this.setFrameIndex(this.frameIndex);
};

Sprite.prototype.setFrameIndex = function(index)
{
  this.frameIndex = index;
  this.lastFrame = getTime();
};

Sprite.prototype.draw = function(canvas, x, y, w, h, animationDelay, camera, hFlip, r, g, b, transparency)
{
  this.checkFrame(animationDelay);

  this.justDraw(canvas, x, y, w, h, camera, hFlip, r, g, b, transparency);
};

Sprite.prototype.justDraw = function(canvas, x, y, w, h, camera, hFlip, r, g, b, transparency)
{
  canvas.drawImage(this.getImage(r, g, b), x, y, w, h, hFlip, camera, transparency);
};

Sprite.prototype.getImage = function(r, g, b)
{
  return getTintedImage(this.getImageId(), r, g, b);
};

Sprite.prototype.getOriginalImage = function()
{
  return getImage(this.getImageId());
};

Sprite.prototype.getHandlePoint = function(handleId)
{
  return getHandlePoint(this.getImageId(), handleId);
};

Sprite.prototype.getImageId = function()
{
  return this.spriteId + "/" + this.animationId + "/" + this.frameIndex;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// Stock  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Stock(id, amount)
{
  this.id = id;
  this.amount = amount;
}

Stock.prototype.add = function(amount)
{
  this.amount += amount;
};

Stock.prototype.remove = function(amount)
{
  this.amount -= amount;
};

Stock.prototype.getAmount = function()
{
  return this.amount;
};

Stock.prototype.toString = function()
{
  if (this.id == "Cash") {return this.id + ": £" + this.amount;}
  else {return this.id + ": " + this.amount;}
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////// Structure Status Map ////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function StructureStatusMap()
{
  this.map = new Map();
}

StructureStatusMap.prototype.get = function(id)
{
  return this.map.get(id);
};

StructureStatusMap.prototype.set = function(id, state)
{
  this.map.set(id, new StructureStatus(id, state));
};

StructureStatusMap.prototype.registerBuilt = function(id)
{
  this.set(id, "built");
};

StructureStatusMap.prototype.structureIsBuilt = function(id)
{
  var x = this.map.get(id);

  return x != null && x.isBuilt();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// Structure Status //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function StructureStatus(id, state)
{
  this.id = id;
  this.state = state;
}

StructureStatus.prototype.isBuilt = function()
{
  return this.state == "built";
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Structure  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function Structure(id, room, x, y, hFlip, targetRoom, targetX, targetY)
{
  this.id = id;
  this.room = room;
  this.x = x;
  this.y = y;
  this.hFlip = hFlip;
  this.targetRoom = targetRoom;
  this.targetX = targetX;
  this.targetY = targetY;

  this.room.addStructure(this);

  this.interactCount = 0;
  this.burning = 0;
  this.sizzle = null;
  this.flameSprite = new Sprite("flame", "normal");
}

Structure.prototype.doTime = function()
{
  this.checkBurning();
};

Structure.prototype.checkBurning = function()
{
  if (this.isBurning())
  {
    this.r *= 0.99;
    this.g *= 0.99;
    this.b *= 0.99;

    if (this.sizzle == null)
    {
      this.sizzle = playSound("burn/sizzle", true);
    }
    else
    {
      var v = Math.min(Math.max((this.burning - getTime()) / 1000, 0), 1);
      this.sizzle.setVolume(v);
    }
  }
  else if (this.sizzle != null)
  {
    this.sizzle.trash();
    this.sizzle = null;
  }
};

Structure.prototype.setOnFire = function()
{
  if (this.isFlamable) {this.burning = getTime() + 5000;}
};

Structure.prototype.isBurning = function()
{
  return getTime() < this.burning;
};

Structure.prototype.tryInteract = function(x)
{
  if (x < this.x + this.w && x > this.x)
  {
    if (this.isStageExit)
    {
      var f = function() {this.room.world.exitStage = true;}

      dialog("Exit this stage?", [new DialogOption("Yes", f.bind(this)), new DialogOption("No", function(){})]);
    }
    else if (this.isInDoorway(x))
    {
      this.room.world.enterRoom(this.targetRoom, this.targetX, this.targetY);
    }
    else
    {
      this.interactCount++;
      this.interact();
    }

    return true;
  }

  return false;
};

Structure.prototype.tryBuild = function(structureName)
{
  var levelMet = game.motherBase.getSkillLevel("Construction") >= this.constructionLevel;
  var hasStuff = game.inventory.has(this.constructionResources);
  var options = [];

  if (levelMet && hasStuff)
  {
    options.push(new DialogOption("Build", this.build.bind(this)));
  }

  dialog(structureName + ", requirements: \n " + this.getBuildRequirementsAsString(), options);
};

Structure.prototype.build = function()
{
  game.inventory.use(this.constructionResources);
  game.registerBuilt(this.id);

  this.buildAs();
};

Structure.prototype.getBuildRequirementsAsString = function()
{
  var s = "";
  var arr = this.constructionResources;

  if (game.motherBase.getSkillLevel("Construction") < this.constructionLevel)
  {
    s = "Construction level: " + this.constructionLevel;
  }

  for (var i = 0; i < arr.length; i++)
  {
    if (s != "") {s = s + " \n ";}
    s = s + arr[i][0] + " x" + arr[i][1];
  }

  return s;
}

Structure.prototype.isInDoorway = function(x)
{
  var x1 = this.x + this.doorX * this.w;
  var x2 = x1 + this.doorWidth * this.w;

  return (this.targetRoom != null && x > x1 && x < x2);
};

Structure.prototype.getShadowIntensity = function(x)
{
  return 0;
};

Structure.prototype.draw = function(canvas, camera)
{
  var bright = this.room.getBaseBrightness() * 255;
  var r = this.r * bright;
  var g = this.g * bright;
  var b = this.b * bright;

  if (this.sprite != null)
  {
    this.sprite.draw(canvas, this.x, this.y, this.w, this.h, 1000, camera, this.hFlip, r, g, b, 0);
  }
  else
  {
    canvas.ctx.globalAlpha = 1;

    if (this.hFlip)
    {
      canvas.ctx.translate(asWidth(this.x) + asWidth(this.w) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
      canvas.ctx.scale(-1, 1);
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }
    else
    {
      canvas.ctx.translate(asWidth(this.x) - asWidth(camera.x), asHeight(this.y) - asHeight(camera.y));
      this.sketch(canvas.ctx, asWidth(this.w), asHeight(this.h), bright / 255);
    }

    canvas.ctx.setTransform(1, 0, 0, 1, 0, 0);
  }
};

Structure.prototype.drawLight = function(canvas, camera)
{
  if (this.isBurning())
  {
    var vis = Math.min(Math.max((this.burning - getTime()) / 1000, 0), 1);

    this.flameSprite.draw(canvas, this.x, this.y, this.w, this.h, 100, camera, false, 255, 255, 255, 1 - vis);
  }
};

Structure.prototype.interact = function() {};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Wait Step  /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function WaitStep(waitTime)
{
  this.waitTime = waitTime * 1000;

  this.started = false;
}

WaitStep.prototype.start = function()
{
  this.targetTime = getTime() + this.waitTime;

  this.started = true;
};

WaitStep.prototype.isDone = function()
{
  if (!this.started) {this.start();}

  return getTime() > this.targetTime;
};

WaitStep.prototype.getMoveDirection = function()
{
  return 0;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// World  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function World(id, canvas)
{
  this.id = id;
  this.canvas = canvas;

  this.controls = new Controls();
  this.camera = new Camera(0, 0, 1);
  this.rooms = [];
  this.player = null;
  this.activeRoom = null;
  this.transitionRoom = null;
  this.transitionIn = 0;
  this.transitionOut = 0;
  this.transitionX = 0;
  this.transitionY = 0;
  this.dialogBox = new DialogBox(0.5, 0.1, 0.45, 0.2, this.canvas, 30);

  this.create(this.id);

  if (this.id == "mb")
  {
    game.motherBaseVisits++;

    this.generateMbStaff();
  }

  this.player = new Character("player", null, 0.1, 0, false, null);
  this.player.setAsPlayer();

  this.startRoom(this.rooms[0], 0.1, 0);

  this.birth = getTime();
  this.stageStarted = true;
  this.stageEnded = false;
  this.stageEndTime = 0;
  this.exitStage = false;
  this.characterStatusMap = new CharacterStatusMap();
}

World.prototype.hasEscaped = function()
{
  return this.exitStage;
};

World.prototype.generateMbStaff = function()
{
  var x = Math.min(game.motherBase.getStaffCount(), 50);
  var w = this.rooms[0].stageWidth;
  var arr = Array.from(game.motherBase.charMap.values());

  for (var i = 0; i < x; i++)
  {
    var c = new Character("mbStaff" + i, this.rooms[0], Math.random() * w, 0, Math.random() < 0.5,
      new PatrolRoute([new WaitStep(Math.random() * 10 + 10), new PatrolStep(Math.random() * w),
      new WaitStep(Math.random() * 10 + 10), new PatrolStep(Math.random() * w)]), arr[i]);

    c.setAsCivilianMinion();
    c.interact = function() {dialog(this.skillSet.toString());};

    this.rooms[0].characters.splice(this.rooms[0].characters.length - 1);
    this.rooms[0].characters.unshift(c);
  }
};

World.prototype.addRoom = function(r)
{
  this.rooms.push(r);
};

World.prototype.doTime = function()
{
  this.checkMusic();

  var active = !this.checkRoomTransition();

  this.checkControls(active);

  this.activeRoom.doTime(active);

  if (!this.stageEnded && (this.player.isDead() || this.missionFailed() || this.missionSuccess()))
  {
    this.stageEnded = true;
    this.stageEndTime = getTime();

    if (this.missionSuccess())
    {
      this.registerMissionComplete();
      this.mergeCharacterStatusMap();
      playMusic("mission complete");
    }
    else
    {
      playMusic("game over");
    }
  }
};

World.prototype.mergeCharacterStatusMap = function()
{
  arr = Array.from(this.characterStatusMap.map.values());

  for (var i = 0; i < arr.length; i++)
  {
    if (this.id != "mb")
    {
      game.characterStatusMap.set(arr[i].char, arr[i].state);
      game.characterStatusMap.clearChar(arr[i].char.id);
    }

    if (this.id != "mb" && arr[i].isRescued()) {game.addToStaff(arr[i].char);}
    else if (this.id == "mb" && arr[i].isDead()) {game.removeFromStaff(arr[i].char);}
  }
};

World.prototype.getRoomById = function(id)
{
  return arrayGetById(this.rooms, id);
};

World.prototype.getById = function(id)
{
  for (var i = 0; i < this.rooms.length; i++)
  {
    var obj = this.rooms[i].getById(id);
    if (obj != null) {return obj;}
  }

  return null;
};

World.prototype.getCharacterCount = function()
{
  var x = 0;

  for (var i = 0; i < this.rooms.length; i++)
  {
    x += this.rooms[i].characters.length;
  }

  return x;
};

World.prototype.containsId = function(id)
{
  return this.getById(id) != null;
};

World.prototype.checkRoomTransition = function()
{
  if (this.transitionOut != 0)
  {
    if (getTime() > this.transitionOut + 1000)
    {
      this.activeRoom = this.transitionRoom;
      this.activeRoom.enter();
      this.player.room = this.activeRoom;
      this.player.x = this.transitionX;
      this.player.y = this.transitionY;
      this.transitionX = 0;
      this.transitionY = 0;
      this.transitionRoom = null;
      this.transitionOut = 0;
      this.transitionIn = getTime();
    }
  }
  else if (this.transitionIn != 0)
  {
    if (getTime() > this.transitionIn + 1000)
    {
      this.transitionIn = 0;
    }
  }

  return this.transitionOut != 0;
};

World.prototype.startRoom = function(room, playerX, playerY)
{
  this.transitionRoom = room;
  this.transitionX = playerX;
  this.transitionY = playerY;
  this.transitionOut = 1;
};

World.prototype.enterRoom = function(room, playerX, playerY)
{
  this.transitionRoom = room;
  this.transitionX = playerX;
  this.transitionY = playerY;
  this.transitionIn = 0;
  this.transitionOut = getTime() + 1000;
};

World.prototype.getFade = function()
{
  if (this.transitionIn != 0)
  {
    return Math.min(Math.max((getTime() - this.transitionIn) / 1000, 0), 1);
  }
  else if (this.transitionOut != 0)
  {
    return Math.min(Math.max((this.transitionOut - getTime()) / 1000, 0), 1);
  }
  else
  {
    return 1;
  }
};

World.prototype.checkMusic = function()
{
  var vol = 1;
  if (this.transitionOut != 0) {vol = this.getFade();}

  soundController.setFadeVolume(vol);
};

World.prototype.setDialog = function(txt, options, timeout)
{
  this.dialogBox.setDialog(txt, options, timeout);
};

World.prototype.appendDialog = function(txt)
{
  this.dialogBox.appendDialog(txt);
};

World.prototype.checkControls = function(active)
{
  if (this.controls.getKeyState(27) == 1)
  {
    if (this.id == "mb") 
    {
      this.mergeCharacterStatusMap();
      game.enterMenu();
    }
    else if (!this.stageEnded)
    {
      dialog("Exit this stage? Any rescued characters will not count towards your staff. \n Are you sure?",
        [new DialogOption("Yes", function() {game.enterMenu();}), new DialogOption("No", function(){})]);
    }
    else
    {
      game.enterMenu();
    }
  }

  if (this.stageStarted && active) {this.player.checkControls(this.controls);}
};

World.prototype.allThreatsNeutralised = function()
{
  for (var i = 0; i < this.rooms.length; i++)
  {
    if (!this.rooms[i].allThreatsNeutralised()) {return false;}
  }

  return true;
};

World.prototype.getCharacterStatus = function(id)
{
  return this.characterStatusMap.get(id);
};

World.prototype.charIsDead = function(id)
{
  return this.characterStatusMap.charIsDead(id);
};

World.prototype.charIsRescued = function(id)
{
  return this.characterStatusMap.charIsRescued(id);
};

World.prototype.charIsNeutralised = function(id)
{
  return this.characterStatusMap.charIsNeutralised(id);
};

World.prototype.registerDeath = function(char)
{
  this.characterStatusMap.registerDeath(char);
};

World.prototype.registerRescued = function(char)
{
  this.characterStatusMap.registerRescued(char);
};

World.prototype.registerMissionComplete = function()
{
  game.missionStatusMap.registerComplete(this.id);
};

World.prototype.drawPlayer = function()
{
  this.player.drawAsForeground(this.canvas, this.camera);
};

World.prototype.drawPlayerLight = function()
{
  this.player.drawLight(this.canvas, this.camera);
};

World.prototype.drawCountdown_NOT_USED = function()
{
  var t = getTime() - this.birth;
  var fade = (t % 1000) / 1000;
  var num = Math.floor(4 - (t + fade) / 1000);

  if (num > 0)
  {
    this.canvas.ctx.fillStyle = "#da4";
    this.canvas.ctx.globalAlpha = 1 - fade;
    this.canvas.ctx.font = asWidth(0.3) + "px Century Gothic";
    this.canvas.ctx.fillText(num, asWidth(0.4), asHeight(0.5));
  }
  else
  {
    this.stageStarted = true;
  }
};

World.prototype.drawHud = function()
{
  this.canvas.ctx.fillStyle = "#ddd";
  this.canvas.ctx.globalAlpha = this.getFade();
  this.canvas.ctx.font = asWidth(0.03) + "px Century Gothic Bold";

  var percent = this.player.hp / this.player.maxHp;
  var r = Math.round((1 - percent) * this.getFade() * 255);
  var g = Math.round(percent * this.getFade() * 255);
  var b = 0;
  this.canvas.ctx.fillStyle = "rgb(" + r + ", " + g + ", " + b + ")";

  this.canvas.ctx.fillText("Health: " + Math.round(this.player.hp) + " / " + Math.round(this.player.maxHp), asWidth(0.1), asHeight(0.1));
};

World.prototype.drawMissionEnd = function()
{
  if (this.stageEnded)
  {
    var transparency = Math.min(Math.max(1 - ((getTime() - this.stageEndTime) / 1000), 0), 1);
    var msg;

    this.canvas.colourRect("#222", 0.05, 0.36, 0.5, 0.25, nullCamera, transparency);

    this.canvas.ctx.fillStyle = "#cea";
    this.canvas.ctx.font = asWidth(0.03) + "px Century Gothic";

    if (this.player.isDead())
    {
      msg = "You Died";
    }
    else if (this.missionFailed())
    {
      msg = "Mission Failed";
    }
    else if (this.missionSuccess())
    {
      msg = "Mission Complete";
    }

    this.canvas.ctx.fillText(msg, asWidth(0.1), asHeight(0.45));
    this.canvas.ctx.fillText("Press the Ecsape key to exit", asWidth(0.1), asHeight(0.55));
  }
};

World.prototype.drawDialogBox = function()
{
  this.dialogBox.draw();
};

World.prototype.keyDown = function(e)
{
  this.controls.setKeyState(e.keyCode, true);
};

World.prototype.keyUp = function(e)
{
  this.controls.setKeyState(e.keyCode, false);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// minion ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Character.prototype.sketchMinion = function(ctx, w, h, brightness, headColour, eyeColour, bodyColour, armColour, legColour)
{
  var drop = 0;
  if (this.timeOfDeath != 0 || this.hostage) {drop = Math.min((getTime() - this.timeOfDeath) / 1000, 1);}
  var dropCentreX = w * 0.5;
  var dropCentreY = h * 0.5;
  var dropRotation = -drop * Math.PI / 2;
  var dropY = drop * h / 2;

  var pos = function(x, y) {return new Point(x, y).rotateAbout(dropCentreX, dropCentreY, dropRotation).translate(0, dropY);};
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var headColourString = col(this, headColour);
  var eyeColourString = col(this, eyeColour);
  var bodyColourString = col(this, bodyColour);
  var armColourString = col(this, armColour);
  var legColourString = col(this, legColour);
  var black = "rgb(0, 0, 0)";

  var bodyPos = pos(w / 2, h / 2);
  var headPos = pos(w * 0.55, h / 5);

  var leftLegJoint = pos(w * 0.47, h * 0.8);
  var rightLegJoint = pos(w * 0.53, h * 0.8);
  var armJoint = pos(w * 0.4, h * 0.4);

  var eyePos = pos(w * 0.75, h / 6);
  var eyeW = w / 6;
  var eyeH = h / 6;
  var eyePupilPos = pos(w * 0.8, h / 7);
  var blink = Math.max(Math.sin(getTime() / 3000) - 0.9, 0) * 10;
  if (this.activeAnimation == "surprised" || this.activeAnimation == "getting stabbed" || this.activeAnimation == "burning") {blink = Math.max(Math.sin(getTime() / 50), 0);}
  if (this.timeOfDeath != 0) {blink = 0.9;}

  var foot = 0.58;
  if (this.activeAnimation == "walking" || this.activeAnimation == "burning") {foot = Math.sin((getTime() - this.walkStartTime) / 100) * 0.1 + 0.5;}

  var leftFoot = pos(w * (1 - foot), h);
  var rightFoot = pos(w * foot, h);
  var hand = pos(w * foot, h * 0.6);

  // Left Leg
  ctx.lineWidth = w / 10;
  ctx.beginPath();
  ctx.moveTo(leftLegJoint.x, leftLegJoint.y);
  ctx.lineTo(leftFoot.x, leftFoot.y);
  ctx.strokeStyle = legColourString;
  ctx.stroke();

  // Body
  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, bodyPos.x, bodyPos.y, w / 2, h / 3, dropRotation, 0, 2 * Math.PI);
  ctx.fillStyle = bodyColourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Head
  ctx.beginPath();
  ellipse(ctx, headPos.x, headPos.y, w / 3, h / 5, dropRotation, 0, 2 * Math.PI);
  ctx.fillStyle = headColourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Eye Ball
  ctx.beginPath();
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH, dropRotation, 0, 2 * Math.PI);
  ctx.fillStyle = eyeColourString;
  ctx.fill();

  // Eye Pupil
  ctx.beginPath();
  ctx.arc(eyePupilPos.x, eyePupilPos.y, w / 20, 0, 2 * Math.PI);
  ctx.fillStyle = black;
  ctx.fill();

  // Eye Lid Upper
  ctx.beginPath();
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH * (1 - blink), dropRotation, Math.PI, 0);
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH, dropRotation, 0, Math.PI, true);
  ctx.fillStyle = headColourString;
  ctx.fill();

  // Eye Lid Lower
  ctx.beginPath();
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH * (1 - blink), dropRotation, Math.PI, 0, true);
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH, dropRotation, 0, Math.PI);
  ctx.fillStyle = headColourString;
  ctx.fill();

  // Eye Lid Outline
  ctx.beginPath();
  ellipse(ctx, eyePos.x, eyePos.y, eyeW, eyeH * (1 - blink), dropRotation, 0, 2 * Math.PI);
  ctx.strokeStyle = black;
  ctx.stroke();

  // Right Leg
  ctx.lineWidth = w / 10;
  ctx.beginPath();
  ctx.moveTo(rightLegJoint.x, rightLegJoint.y);
  ctx.lineTo(rightFoot.x, rightFoot.y);
  ctx.strokeStyle = legColourString;
  ctx.stroke();

  // Arm
  ctx.beginPath();
  ctx.moveTo(armJoint.x, armJoint.y);
  ctx.lineTo(hand.x, hand.y);
  ctx.strokeStyle = armColourString;
  ctx.stroke();

  this.hand1.x = hand.x / w;
  this.hand1.y = hand.y / h;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////// flame thrower  ///////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Gun.prototype.sketchFlameThrower = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var gripPos = pos(w / 5, h * 0.6);
  var gripW = w / 5;
  var gripH = h * 0.75;
  var slidePos = pos(w / 2, h / 4);
  var slideW = w;
  var slideH = h / 2;

  // Grip
  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, gripPos.x, gripPos.y, gripW, gripH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Slide
  ctx.beginPath();
  ellipse(ctx, slidePos.x, slidePos.y, slideW, slideH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  this.grip.x = gripPos.x / w;
  this.grip.y = gripPos.y / h;
  this.tip.x = (slidePos.x + slideW / 2) / w;
  this.tip.y = slidePos.y / h;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// handgun  //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Gun.prototype.sketchHandgun = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var gripPos = pos(w / 5, h * 0.6);
  var gripW = w / 5;
  var gripH = h * 0.75;
  var slidePos = pos(w / 2, h / 4);
  var slideW = w;
  var slideH = h / 2;

  // Grip
  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, gripPos.x, gripPos.y, gripW, gripH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Slide
  ctx.beginPath();
  ellipse(ctx, slidePos.x, slidePos.y, slideW, slideH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  this.grip.x = gripPos.x / w;
  this.grip.y = gripPos.y / h;
  this.tip.x = (slidePos.x + slideW / 2) / w;
  this.tip.y = slidePos.y / h;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// machine gun  ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Gun.prototype.sketchMachineGun = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var gripPos = pos(w / 5, h * 0.6);
  var gripW = w / 5;
  var gripH = h * 0.75;
  var slidePos = pos(w / 2, h / 4);
  var slideW = w;
  var slideH = h / 2;

  // Grip
  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, gripPos.x, gripPos.y, gripW, gripH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Slide
  ctx.beginPath();
  ellipse(ctx, slidePos.x, slidePos.y, slideW, slideH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  this.grip.x = gripPos.x / w;
  this.grip.y = gripPos.y / h;
  this.tip.x = (slidePos.x + slideW / 2) / w;
  this.tip.y = slidePos.y / h;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// shotgun  //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Gun.prototype.sketchShotgun = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var gripPos = pos(w / 5, h * 0.6);
  var gripW = w / 5;
  var gripH = h * 0.75;
  var slidePos = pos(w / 2, h / 4);
  var slideW = w;
  var slideH = h / 2;

  // Grip
  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, gripPos.x, gripPos.y, gripW, gripH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  // Slide
  ctx.beginPath();
  ellipse(ctx, slidePos.x, slidePos.y, slideW, slideH, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();

  this.grip.x = gripPos.x / w;
  this.grip.y = gripPos.y / h;
  this.tip.x = (slidePos.x + slideW / 2) / w;
  this.tip.y = slidePos.y / h;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// coin ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Item.prototype.sketchCoin = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var mainPos = pos(w / 2, h / 2);

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, mainPos.x, mainPos.y, w, h, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// fuel ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Item.prototype.sketchFuel = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var mainPos = pos(w / 2, h / 2);

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, mainPos.x, mainPos.y, w, h, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// wood ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Item.prototype.sketchWood = function(ctx, w, h, brightness, colour)
{
  var pos = function(x, y) {return new Point(x, y);};

  var colourString = colour.adjustBrightness(brightness).toString();
  var black = "rgb(0, 0, 0)";

  var mainPos = pos(w / 2, h / 2);

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ellipse(ctx, mainPos.x, mainPos.y, w, h, 0, 0, 2 * Math.PI);
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// clouds ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Room.prototype.sketchClouds = function(ctx, w, h, brightness, skyColour, cloudColour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.backgroundR / 255, brightness * obj.backgroundG / 255, brightness * obj.backgroundB / 255).toString();};
  var colPlain = function(obj, c) {return c.adjustBrightness(brightness).toString();};

  var drawCloud = function(x, y, cw, ch)
  {
    ctx.beginPath();
    ctx.moveTo(x + cw * 0.4, y + ch * 0.4);
    ctx.bezierCurveTo(x + cw * 0.3, y + ch * 0.5, x + cw * 0.3, y + ch * 0.75, x + cw * 0.6, y + ch * 0.75);
    ctx.bezierCurveTo(x + cw * 0.6, y + ch * 0.9, x + cw * 0.8, y + ch * 0.9, x + cw * 0.85, y + ch * 0.75);
    ctx.bezierCurveTo(x + cw, y + ch * 0.75, x + cw, y + ch * 0.6, x + cw * 0.9, y + ch * 0.5);
    ctx.bezierCurveTo(x + cw, y + ch * 0.2, x + cw * 0.9, y + ch * 0.15, x + cw * 0.85, y + ch * 0.25);
    ctx.bezierCurveTo(x + cw * 0.8, y, x + cw * 0.62, y + ch * 0.1, x + cw * 0.62, y + ch * 0.25);
    ctx.bezierCurveTo(x + cw * 0.5, y, x + cw * 0.7, y + ch * 0.1, x + cw * 0.3, y + ch * 0.4);
    ctx.closePath();
    ctx.stroke();
    ctx.fill();
  };

  var skyColourString = col(this, skyColour);
  var cloudColourString = colPlain(this, cloudColour);
  var black = "rgb(0, 0, 0)";
  ctx.strokeStyle = black;
  ctx.lineWidth = w / 1000;

  ctx.fillStyle = skyColourString;
  ctx.fillRect(0, 0, w, h);

  ctx.fillStyle = cloudColourString;
  drawCloud(0.1 * w, 0.1 * h, 0.1 * w, 0.1 * h);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// crate  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchCrate = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var black = "rgb(0, 0, 0)";
  ctx.strokeStyle = black;

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w, 0);
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// door ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchDoor = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var black = "rgb(0, 0, 0)";

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w, h / 10);
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// helicopter /////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchHelicopter = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var doorColourString = col(this, colour.adjustBrightness(0.7));
  var black = "rgb(0, 0, 0)";
  ctx.strokeStyle = black;

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(w * 0.75, h * 0.75);
  ctx.bezierCurveTo(w * 0.8, h * 0.7, w * 0.8, h * 0.5, w * 0.75, h * 0.4);
  ctx.bezierCurveTo(w * 0.7, h * 0.15, w * 0.3, h * 0.15, w * 0.25, h * 0.4);
  ctx.bezierCurveTo(0, h * 0.6, 0, h * 0.65, w * 0.25, h * 0.75);
  ctx.closePath();
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(w * 0.48, h * 0.45);
  ctx.bezierCurveTo(w * 0.2, h * 0.5, w * 0.1, h * 0.6, w * 0.27, h * 0.74);
  ctx.lineTo(w * 0.46, h * 0.74);
  ctx.closePath();
  ctx.fillStyle = doorColourString;
  ctx.fill();
  ctx.stroke();

  ctx.lineWidth = w / 50;
  ctx.beginPath();
  ctx.moveTo(w * 0.4, h * 0.75);
  ctx.lineTo(w * 0.35, h * 0.98);
  ctx.stroke();

  ctx.moveTo(w * 0.6, h * 0.75);
  ctx.lineTo(w * 0.65, h * 0.98);
  ctx.stroke();

  ctx.moveTo(0, h * 0.95);
  ctx.bezierCurveTo(w * 0.3, h, w * 0.7, h, w, h * 0.95);
  ctx.stroke();

  ctx.moveTo(w * 0.5, h * 0.2);
  ctx.lineTo(w * 0.5, 0);
  ctx.stroke();

  ctx.moveTo(0, 0);
  ctx.lineTo(w, 0);
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// shack  ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchShack = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var black = "rgb(0, 0, 0)";

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(0, h);
  ctx.lineTo(w, h);
  ctx.lineTo(w, h / 3);
  ctx.lineTo(w / 2, 0);
  ctx.lineTo(0, h / 3);
  ctx.closePath();
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// shadow ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchShadow = function(ctx, w, h, brightness, intensity)
{
  var black = "rgba(0, 0, 0, " + intensity + ")";
  var transparent = "rgba(0, 0, 0, 0)";

  var grd = ctx.createRadialGradient(w / 2, h / 2, 0, w / 2, h / 2, w / 2);
  grd.addColorStop(0, black);
  grd.addColorStop(1, transparent);

  ctx.beginPath();
  ellipse(ctx, w / 2, h / 2, w, h, 0, 0, 2 * Math.PI);
  ctx.fillStyle = grd;
  ctx.fill();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// shop ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchShop = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var darkColourString = col(this, colour.adjustBrightness(0.6));
  var black = "rgb(0, 0, 0)";

  ctx.strokeStyle = black;
  ctx.lineWidth = w / 100;

  ctx.fillStyle = darkColourString;
  ctx.beginPath();
  ctx.moveTo(0, h * 0.2);
  ctx.lineTo(0, h * 0.8);
  ctx.lineTo(w * 0.05, h * 0.8);
  ctx.lineTo(w * 0.05, h * 0.2);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(w * 0.95, h * 0.2);
  ctx.lineTo(w * 0.95, h * 0.8);
  ctx.lineTo(w, h * 0.8);
  ctx.lineTo(w, h * 0.2);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = colourString;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w, 0);
  ctx.lineTo(w, h * 0.2);
  ctx.lineTo(0, h * 0.2);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, h * 0.8);
  ctx.lineTo(w, h * 0.8);
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// sign ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchSign = function(ctx, w, h, brightness, colour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var colourString = col(this, colour);
  var black = "rgb(0, 0, 0)";

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w * 0.7, h * 0.02);
  ctx.lineTo(w, h * 0.1);
  ctx.lineTo(w * 0.75, h * 0.2);
  ctx.lineTo(w * 0.55, h * 0.22);
  ctx.lineTo(w * 0.54, h);
  ctx.lineTo(w * 0.44, h);
  ctx.lineTo(w * 0.45, h * 0.22);
  ctx.lineTo(0, h * 0.21);
  ctx.closePath();
  ctx.fillStyle = colourString;
  ctx.fill();
  ctx.strokeStyle = black;
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// tree ////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Structure.prototype.sketchTree = function(ctx, w, h, brightness, trunkColour, leafColour)
{
  var col = function(obj, c) {return c.multiply(brightness * obj.r, brightness * obj.g, brightness * obj.b).toString();};

  var trunkColourString = col(this, trunkColour);
  var leafColourString = col(this, leafColour);
  var black = "rgb(0, 0, 0)";
  ctx.strokeStyle = black;

  ctx.lineWidth = w / 100;
  ctx.beginPath();
  ctx.moveTo(w * 0.4, h * 0.7);
  ctx.bezierCurveTo(w * 0.38, h * 0.8, w * 0.36, h * 0.9, w * 0.35, h);
  ctx.lineTo(w * 0.65, h);
  ctx.bezierCurveTo(w * 0.64, h * 0.9, w * 0.62, h * 0.8, w * 0.6, 0.7);
  ctx.closePath();
  ctx.fillStyle = trunkColourString;
  ctx.fill();
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(w * 0.5, 0);
  ctx.bezierCurveTo(w * 0.75, h * 0.33, w * 0.55, h * 0.6, w * 0.5, h * 0.75);
  ctx.bezierCurveTo(w * 0.45, h * 0.6, w * 0.25, h * 0.33, w * 0.5, 0);
  ctx.fillStyle = leafColourString;
  ctx.fill();
  ctx.stroke();
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// general  //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function asWidth(z)
{
  return window.innerWidth * z;
}

function asHeight(z)
{
  return window.innerHeight * z;
}

function getTime()
{
  var d = new Date();

  return d.getTime();
}

function setDoc(html)
{
  document.body.innerHTML = html;
}

function garbageAndDraw(arr, canvas, camera)
{
  garbageCollectArray(arr);
  drawArray(arr, canvas, camera);
}

function drawArray(arr, canvas, camera)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].draw(canvas, camera);
  }
}

function drawKnifedArray(arr, canvas, camera)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].drawAsKnifed(canvas, camera);
  }
}

function drawForegroundArray(arr, canvas, camera)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].drawAsForeground(canvas, camera);
  }
}

function drawBackgroundArray(arr, canvas, camera)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].drawAsBackground(canvas, camera);
  }
}

function drawLightArray(arr, canvas, camera)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].drawLight(canvas, camera);
  }
}

function doTimeArray(arr)
{
  for (var i = 0; i < arr.length; i++)
  {
    arr[i].doTime();
  }
}

function garbageCollectArray(arr)
{
  for (var i = arr.length - 1; i >= 0; i--)
  {
    if (arr[i].toDelete())
    {
      arr.splice(i, 1);
    }
  }
}

function arrayGetById(arr, id)
{
  for (var i = 0; i < arr.length; i++)
  {
    if (arr[i].id == id) {return arr[i];}
  }

  return null;
}

function getById(arr, id)
{
  return game.world.getById(arr, id);
}

function containsId(arr, id)
{
  return getById(arr, id) != null;
}

function dialog(txt, options, timeout)
{
  game.world.setDialog(txt, options, typeof timeout == "undefined" ? 0 : timeout);
}

function appendDialog(txt)
{
  game.world.appendDialog(txt);
}

function convertParagraphToLinesArray(txt, maxLineChars)
{
  var words = txt.split(" ");
  var thisLine = "";
  var lines = [];

  for (var i = 0; i < words.length; i++)
  {
    if (words[i] != "\n" && thisLine.length + words[i].length < maxLineChars)
    {
      if (thisLine != "") {thisLine = thisLine + " ";}

      thisLine = thisLine + words[i];
    }
    else
    {
      lines.push(thisLine);
      thisLine = words[i] != "\n" ? words[i] : "";
    }
  }

  if (thisLine != "") {lines.push(thisLine);}

  return lines;
}

function getRoomById(id)
{
  return game.world.getRoomById(id);
}

function missionIsComplete(id)
{
  return game.missionStatusMap.missionIsComplete(id);
}

function structureIsBuilt(id)
{
  return game.structureStatusMap.structureIsBuilt(id);
}

function charIsDead(id)
{
  return game.characterStatusMap.charIsDead(id);
}

function charIsRescued(id)
{
  return game.characterStatusMap.charIsRescued(id);
}

function charIsNeutralised(id)
{
  return game.characterStatusMap.charIsNeutralised(id);
}

function inventoryAdd(id, amount)
{
  game.inventory.add(id, amount);
}

function inventoryHas(arr)
{
  return game.inventory.has(arr);
}

function inventoryUse(arr)
{
  return game.inventory.use(arr);
}

function inventoryToString(separator)
{
  return game.inventory.toString(separator);
}

function playSound(snd, loop)
{
  var s = soundController.addSound(snd, loop);
  s.play();

  return s;
}

function playMusic(trackName)
{
  soundController.setMusic(trackName);
}

function clearAllSounds()
{
  return soundController.clearAll();
}

function switchMusicOnOff()
{
  soundController.musicMasterVolume = 1 - soundController.musicMasterVolume;
  soundController.resetVolume();
}

function switchSoundOnOff()
{
  soundController.soundMasterVolume = 1 - soundController.soundMasterVolume;
  soundController.resetVolume();
}

function isOnScreen(x, y, w, h, camera)
{
  return x + w - camera.x > 0 && x - camera.x < 1 && y + h - camera.y > 0 && y - camera.y < 1;
}

function ellipse(ctx, x, y, w, h, rot, startAngle, endAngle, anti)
{
  ctx.ellipse(x, y, w, h, rot, startAngle, endAngle, anti);
}

function eatFood(x)
{
  var hp = game.getPlayerMaxHp();
  var hpBoost = Math.round(x / 10);

  game.foodPoints += x;

  if (game.world != null)
  {
    game.world.player.maxHp = game.getPlayerMaxHp();

    if (game.world.player.maxHp > hp) {appendDialog(" \n Max HP increased to " + game.world.player.maxHp);}

    game.world.player.setHp(game.world.player.hp + hpBoost);
  }
  else
  {
    game.playerHp += hpBoost;
  }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////// image loader ////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function loadAllImages()
{
  loadImage("world map/plain/0", new Map());
  loadImage("texture/grass/0", new Map());
  loadImage("texture/dirt/0", new Map());
  loadImage("texture/sand/0", new Map());
  loadImage("texture/concrete/0", new Map());
  loadImage("texture/snow/0", new Map());
  loadImage("texture/flow/0", new Map());
  loadImage("texture/flow/1", new Map());
  loadImage("texture/flow/2", new Map());
  loadImage("texture/flow/3", new Map());
  loadImage("texture/sky/0", new Map());
  loadImage("texture/wall/0", new Map());
  loadImage("texture/stone wall/0", new Map());
  loadImage("texture/shadow/0", new Map());
  loadImage("flame/normal/0", new Map());
  loadImage("flame/normal/1", new Map());
  loadImage("knife/ready/0", new Map([["grip", new Point(0.1, 0.3)], ["tip", new Point(0.9, 0.7)]]));
  loadImage("flame thrower/flame/0", new Map([["tip", new Point(0, 0.55)]]));
  loadImage("flame thrower/flame/1", new Map([["tip", new Point(0, 0.45)]]));
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// images ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function getImage(imageName)
{
  return loadedImages.getImage(imageName);
}

function getTintedImage(imageName, r, g, b)
{
  return loadedImages.getTintedImage(imageName, r, g, b);
}

function getHandlePoint(imageName, handleId)
{
  return loadedImages.getHandlePoint(imageName, handleId);
}

function imageExists(imageName)
{
  return loadedImages.has(imageName);
}

function loadImage(imageName, handlePoints)
{
  loadedImages.set(imageName, handlePoints);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////// special dialogs  //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function dialogNimler()
{
  if (!missionIsComplete("rescueJohnny"))
  {
    dialog(playerName + ", your first mission will be to grab our first recruit. I've selected a suitable target. " +
      "Go get him. Press the Escape key to exit the stage at any time and return the menu screen.");
  }
  else if (!missionIsComplete("rescueCarter"))
  {
    dialog(playerName + ", for us to start developing weapons we need to recruit a gunsmith. " +
      "I've found one that should be easy enough to locate. Bring him in.");
  }
  else if (!missionIsComplete("recruitInitialStaff"))
  {
    dialog("We need some basic staff in order to boost our team's overall skill levels. " +
      "Carter and Johnny over there are saying they need staff with certain construction skills to build a store for their equipment.");
  }
}

function dialogJohnny()
{
  var snack = new DialogOption("Snack: (200 food)", function()
  {
    if (inventoryUse([["Food", 200]])) {dialog("Enjoy."); eatFood(200);} else {dialog("We don't have enough food in stock for that.");}
  });

  var bigMeal = new DialogOption("Grand Meal: (1000 food)", function()
  {
    if (inventoryUse([["Food", 1000]])) {dialog("Enjoy."); eatFood(1000);} else {dialog("We don't have enough food in stock for that.");}
  });

  var lockpick = new DialogOption("Lockpick Set: £5", function()
  {
    if (inventoryUse([["Cash", 5]])) {dialog("Thanks.");} else {dialog("Not enough cash, stranger.");}
  });

  var chaff = new DialogOption("Chaff Device: £25", function()
  {
    if (inventoryUse([["Cash", 25]])) {dialog("Thanks.");} else {dialog("Not enough cash, stranger.");}
  });

  var inventory = new DialogOption("Show Resource Inventory", function()
  {
    dialog(inventoryToString(" \n "));
  });

  dialog("What would you like?", [snack, bigMeal, lockpick, chaff, inventory]);
}

function dialogCarter()
{
  dialogCarterChooseWeapon();
}

function dialogCarterChooseWeapon()
{
  var p = function(arr, gunName, gunFunc)
  {
    var f = function(gunName, gunFunc, grade)
    {
      var gradeString = "";
      if (grade > 1) {gradeString = " (Grade " + grade + ")";}

      var tranqMsg = "";
      if (gunName == "Tranquiliser Gun") {tranqMsg = " It's weaker and has less range than the regular handgun, however, any targets you take down will be knocked out and then brought back here to add to our staff.";}

      return new DialogOption(gunName + gradeString, function()
      {
        equipWeapon(gunFunc + "_" + grade);
        dialog("Here you go." + tranqMsg);
      });
    };

    var grade = game.weaponDevelopmentData.get(gunName);

    if (grade > 0)
    {
      arr.push(f(gunName, gunFunc, grade));
    }
  };

  var options = [];
  p(options, "Handgun", "Handgun");
  p(options, "Tranquiliser Gun", "Tranq_Gun");
  p(options, "Machine Gun", "Machine_Gun");
  p(options, "Shotgun", "Shotgun");
  p(options, "Flamethrower", "Flamethrower");
  options.push(new DialogOption("Upgrades", dialogWeaponUpgrades));

  dialog("Anything you like?", options);
}

function dialogWeaponUpgrades()
{
  var p = function(arr, gunName, gunFunc)
  {
    var f = function(gunName, gunFunc, grade)
    {
      var gradeString = " (Grade " + grade + ")";

      return new DialogOption(gunName + gradeString, dialogWeaponUpgradeConfirm.bind(this, gunName, gunFunc, grade));
    };

    var grade = game.weaponDevelopmentData.get(gunName);

    if (grade < 2)
    {
      arr.push(f(gunName, gunFunc, grade + 1));
    }
  };

  var options = [];
  p(options, "Handgun", "Handgun");
  p(options, "Tranquiliser Gun", "Tranq_Gun");
  p(options, "Machine Gun", "Machine_Gun");
  p(options, "Shotgun", "Shotgun");
  p(options, "Flamethrower", "Flamethrower");

  if (options.length == 0) {dialog("Nothing more to upgrade.");}
  else {dialog("What to upgrade?", options);}
}

function dialogWeaponUpgradeConfirm(gunName, gunFunc, grade)
{
  var f = function()
  {
    return function()
    {
      if (inventoryUse(req))
      {
        game.weaponDevelopmentData.set(gunName, grade);
        equipWeapon(gunFunc + "_" + grade);
        dialog("Here you go.");
      }
      else
      {
        dialog("Not enough resources I'm afraid.");
      }
    };
  };

  var gradeString = " (Grade " + grade + ")";
  var req = getDevelopmentRequirements(gunFunc + "_" + grade);
  var reqString = " \n " + getDevelopmentRequirementsString(gunFunc + "_" + grade, " \n ");
  var levelMet = game.motherBase.getSkillLevel("Research") >= getDevelopmentLevelRequirement(gunFunc + "_" + grade);
  var has = inventoryHas(req);

  var options = [];
  options.push(new DialogOption("Back", dialogWeaponUpgrades));

  if (!levelMet)
  {
    dialog("Our research team level is not high enough to craft this item." + reqString, options);
  }
  else if (!has)
  {
    dialog("We don't have enough resources to produce this." + reqString, options);
  }
  else
  {
    options.push(new DialogOption("Confirm Upgrade", f()));
    dialog(gunName + gradeString + reqString, options);
  }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////// weapons  //////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function getDevelopmentLevelRequirement(id)
{
  switch (id)
  {
    case "Handgun_1":
    return 0;

    case "Tranq_Gun_1":
    return 0;

    case "Machine_Gun_1":
    return 7;

    case "Shotgun_1":
    return 12;

    case "Flamethrower_1":
    return 30;

    case "Handgun_2":
    return 16;

    case "Tranq_Gun_2":
    return 20;

    case "Machine_Gun_2":
    return 19;

    case "Shotgun_2":
    return 24;

    case "Flamethrower_2":
    return 42;

    default:
    return 0;
  }
}

function getDevelopmentRequirements(id)
{
  switch (id)
  {
    case "Handgun_1":
    return [];

    case "Tranq_Gun_1":
    return [];

    case "Machine_Gun_1":
    return [["Metal", 50]];

    case "Shotgun_1":
    return [["Metal", 150]];

    case "Flamethrower_1":
    return [["Fuel", 500], ["Metal", 350]];

    case "Handgun_2":
    return [["Metal", 350], ["Special Materials", 5]];

    case "Tranq_Gun_2":
    return [["Metal", 450], ["Special Materials", 10]];

    case "Machine_Gun_2":
    return [["Metal", 500], ["Special Materials", 10]];

    case "Shotgun_2":
    return [["Metal", 750], ["Special Materials", 15]];

    case "Flamethrower_2":
    return [["Fuel", 1000], ["Metal", 1350], ["Special Materials", 30]];

    default:
    return [];
  }
}

function getDevelopmentRequirementsString(id, separator)
{
  var s = "";
  var arr = getDevelopmentRequirements(id);

  if (game.motherBase.getSkillLevel("Research") < getDevelopmentLevelRequirement(id))
  {
    s = "Requires research level: " + getDevelopmentLevelRequirement(id);
  }

  for (var i = 0; i < arr.length; i++)
  {
    if (s != "") {s = s + separator;}
    s = s + arr[i][0] + " x" + arr[i][1];
  }

  return s;
}

function equipWeapon(id)
{
  var p = game.world.player;
  var g = new Gun("cartersGun", null, p, 0, 0, false);

  switch (id)
  {
    case "Handgun_1":
    g.setAsHandgun(); break;

    case "Tranq_Gun_1":
    g.setAsTranqGun(); break;

    case "Machine_Gun_1":
    g.setAsMachineGun(); break;

    case "Shotgun_1":
    g.setAsShotgun(); break;

    case "Flamethrower_1":
    g.setAsFlameThrower(); break;

    case "Handgun_2":
    g.setAsHandgun2(); break;

    case "Tranq_Gun_2":
    g.setAsTranqGun2(); break;

    case "Machine_Gun_2":
    g.setAsMachineGun2(); break;

    case "Shotgun_2":
    g.setAsShotgun2(); break;

    case "Flamethrower_2":
    g.setAsFlameThrower2(); break;

    default:
    g.setAsHandgun(); break;
  }

  p.collectGun(g);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////// worlds ///////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
World.prototype.create = function(id)
{
  if (id == "tw1") {this.create_tw1();}
  else if (id == "tw2") {this.create_tw2();}
  else if (id == "tw3") {this.create_tw3();}
  else if (id == "rescueNimler") {this.create_rescueNimler();}
  else if (id == "mb") {this.create_mb();}
  else if (id == "rescueJohnny") {this.create_rescueJohnny();}
  else if (id == "rescueCarter") {this.create_rescueCarter();}
  else if (id == "recruitInitialStaff") {this.create_recruitInitialStaff();}
  else if (id == "eliminateSara") {this.create_eliminateSara();}
  else if (id == "clearOilfield") {this.create_clearOilfield();}
};

MapLocations.prototype.setup = function()
{
  this.add("tw1", 0, 0, "tw1", "test", function() {return false;});
  this.add("tw2", 0, 0, "tw2", "test", function() {return false;});
  this.add("tw3", 0, 0, "tw3", "test", function() {return false;});
  this.add("rescueNimler", 0.55, 0.45, "Rescue Nimler from the prison camp", "Main Op", function() {return !missionIsComplete("rescueNimler");});
  this.add("mb", 0.35, 0.35, "Visit " + baseName + "", "Main Op", function() {return missionIsComplete("rescueNimler");});
  this.add("rescueJohnny", 0.3, 0.2, "Locate and recruit the man called Johnny", "Main Op", function() {return game.motherBaseVisits > 0 && !missionIsComplete("rescueJohnny");});
  this.add("rescueCarter", 0.6, 0.2, "Locate and recruit the gunsmith Carter", "Main Op", function() {return missionIsComplete("rescueJohnny") && !missionIsComplete("rescueCarter");});
  this.add("recruitInitialStaff", 0.8, 0.5, "Locate and pick out potential " + teamName + " staff members from the village of Ta", "Side Op", function() {return missionIsComplete("rescueCarter");});
  this.add("eliminateSara", 0.7, 0.3, "Eliminate the deadly assassin known as Sara", "Side Op", function() {return missionIsComplete("rescueJohnny") && !missionIsComplete("eliminateSara");});
  this.add("clearOilfield", 0.7, 0.2, "Clear out all security at the oilfield", "Side Op", function() {return missionIsComplete("rescueJohnny") && !missionIsComplete("clearOilfield");});
};

World.prototype.create_tw1 = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return false;};

  var r1 = new Room("r1", this, 3, 0.8, [new Point(0, 0.7), new Point(1, 0.6), new Point(2, 0.3), new Point(3, 0.8)], new Sprite("texture", "dirt"), 120, 130, 125, new Sprite("texture", "stone wall"), 100, 150, 255, "0");
  var r2 = new Room("r2", this, 1, 1, [new Point(0, 0.7), new Point(1, 0.7)], new Sprite("texture", "concrete"), 255, 222, 50, new Sprite("texture", "wall"), 255, 255, 255, "1");

  var stick1 = new Character("stick1", r1, 0.77, 0, true, new PatrolRoute([new WaitStep(5), new PatrolStep(0.5), new WaitStep(5), new PatrolStep(0.9)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  stick1.setAsStickMinion();
  stick1.interact = function() {if (this.interactCount % 2 == 1) {dialog("What to do donut head?", [new DialogOption("kill me", function() {getById("r1c1").suicide(); dialog("Goodnight.");}), new DialogOption("kill other guy", function() {if (containsId("r2c1") && !getById("r2c1").isDead()) {getById("r2c1").suicide(); dialog("He's dead now. Good job killswitch hehe.");} else {dialog("He's already dead muppet!");}})]);} else {dialog("Sneak up when his back is turned. :)");}};

  var stickgun = new Gun("stickgun", r1, stick1, 0, 0, false);
  stickgun.setAsShotgun();

  var r1c1 = new Character("r1c1", r1, 0.5, 0, true, new PatrolRoute([new WaitStep(5), new PatrolStep(0.2), new WaitStep(5), new PatrolStep(0.8)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c1.setAsCivilianMinion();
  r1c1.interact = function() {if (this.interactCount % 2 == 1) {dialog("What to do donut head?", [new DialogOption("kill me", function() {getById("r1c1").suicide(); dialog("Goodnight.");}), new DialogOption("kill other guy", function() {if (containsId("r2c1") && !getById("r2c1").isDead()) {getById("r2c1").suicide(); dialog("He's dead now. Good job killswitch hehe.");} else {dialog("He's already dead muppet!");}})]);} else {dialog("Sneak up when his back is turned. :)");}};

  var r1c2 = new Character("r1c2", r1, 2, 0, true, new PatrolRoute([new WaitStep(3), new PatrolStep(1.8), new WaitStep(3), new PatrolStep(2.3)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c2.setAsGuardMinion();
  r1c2.interact = function() {dialog("What to you want?");};
  r1c2.taunt = function() {dialog("Dork.");};

  var r1c1g = new Gun("r1c1g", r1, r1c2, 0, 0, false);
  r1c1g.setAsShotgun();

  var r1c1i = new Item("r1c1i", r1, r1c2, 0, 0);
  r1c1i.setAsCoin();

  var r1g1 = new Gun("r1g1", r1, null, 1, 0, false);
  r1g1.setAsMachineGun();

  var r1i1 = new Item("r1i1", r1, null, 1.2, 0);
  r1i1.setAsCoin();

  var r1s1 = new Structure("r1s1", r1, 1.5, 0, false, null, 0, 0);
  r1s1.setAsShack();

  var r1s1door = new Structure("r1s1door", r1, 1.52, 0.3, false, r2, 0.1, 0);
  r1s1door.setAsShackDoor();

  var r1i2 = new Item("r1i2", r1, null, 1.4, 0);
  r1i2.setAsFuel();

  var r2c1 = new Character("r2c1", r2, 0.5, 0, true, new PatrolRoute([new WaitStep(5), new PatrolStep(0.2), new WaitStep(5), new PatrolStep(0.8)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r2c1.setAsCivilianMinion();
  r2c1.interact = function() {dialog("The other guy knows my killswitch. I'm not too cocky about that thought. It bugs me.");};

  var r2s1 = new Structure("r2s1", r2, 0.02, 0.2, false, null, 0, 0);
  r2s1.setAsShack();

  var r2s1door = new Structure("r2s1door", r2, 0.05, 0.5, false, r1, 1.6, 0);
  r2s1door.setAsShackDoor();

  var r1g2 = new Gun("r1g2", r2, null, 0, 0, false);
  r1g2.setAsFlameThrower();
};

World.prototype.create_tw2 = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return false;};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.7), new Point(5, 0.7)], new Sprite("texture", "grass"), 255, 255, 255, new Sprite("texture", "sky"), 255, 255, 255, "2");

  var r1c1 = new Character("r1c1", r1, 0.3, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c1.setAsCivilianMinion();
  r1c1.interact = function() {dialog("Set floor", [new DialogOption("dirt", function() {var r = getRoomById("r1"); r.groundR = 200; r.groundG = 150; r.groundB = 50; r.groundPattern.setAnimation("dirt");}), new DialogOption("sand", function() {var r = getRoomById("r1"); r.groundR = 255; r.groundG = 222; r.groundB = 0; r.groundPattern.setAnimation("sand");}), new DialogOption("snow", function() {var r = getRoomById("r1"); r.groundR =255; r.groundG = 255; r.groundB = 255; r.groundPattern.setAnimation("snow");}), new DialogOption("lava", function() {var r = getRoomById("r1"); r.groundR = 255; r.groundG = 100; r.groundB = 0; r.groundPattern.setAnimation("");}), new DialogOption("grass", function() {var r = getRoomById("r1"); r.groundR = 0; r.groundG = 255; r.groundB = 0; r.groundPattern.setAnimation("grass");}), new DialogOption("water", function() {var r = getRoomById("r1"); r.groundR = 0; r.groundG = 100; r.groundB = 255; r.groundPattern.setAnimation("");})]);};

  var r1c2 = new Character("r1c2", r1, 0.5, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c2.setAsCivilianMinion();
  r1c2.interact = function() {dialog("Set your colour red", [new DialogOption("all", function() {getRoomById("r1").world.player.r = 1;}), new DialogOption("lots", function() {getRoomById("r1").world.player.r = 0.7;}), new DialogOption("some", function() {getRoomById("r1").world.player.r = 0.3;}), new DialogOption("none", function() {getRoomById("r1").world.player.r = 0;})]);};

  var r1c3 = new Character("r1c3", r1, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c3.setAsCivilianMinion();
  r1c3.interact = function() {dialog("Set your colour green", [new DialogOption("all", function() {getRoomById("r1").world.player.g = 1;}), new DialogOption("lots", function() {getRoomById("r1").world.player.g = 0.7;}), new DialogOption("some", function() {getRoomById("r1").world.player.g = 0.3;}), new DialogOption("none", function() {getRoomById("r1").world.player.g = 0;})]);};

  var r1c4 = new Character("r1c4", r1, 0.9, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c4.setAsCivilianMinion();
  r1c4.interact = function() {dialog("Set your colour blue", [new DialogOption("all", function() {getRoomById("r1").world.player.b = 1;}), new DialogOption("lots", function() {getRoomById("r1").world.player.b = 0.7;}), new DialogOption("some", function() {getRoomById("r1").world.player.b = 0.3;}), new DialogOption("none", function() {getRoomById("r1").world.player.b = 0;})]);};

  var r1c5 = new Character("r1c5", r1, 1.1, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c5.setAsCivilianMinion();
  r1c5.interact = function() {dialog("Set room brightness", [new DialogOption("light", function() {getRoomById("r1").brightness = 1;}), new DialogOption("half", function() {getRoomById("r1").brightness = 0.5;}), new DialogOption("dim", function() {getRoomById("r1").brightness = 0.25;}), new DialogOption("dark", function() {getRoomById("r1").brightness = 0.05;})]);};

  var r1c6 = new Character("r1c6", r1, 2, 0, true, new PatrolRoute([new WaitStep(1), new PatrolStep(1.5)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c6.setAsGuardMinion();
  r1c6.interact = function() {dialog("How did you get here?");};

  var r1c6g = new Gun("r1c6g", r1, r1c6, 0, 0, false);
  r1c6g.setAsShotgun();

  var r1g1 = new Gun("r1g1", r1, null, 0.1, 0, false);
  r1g1.setAsFlameThrower();

  var r1c7 = new Character("r1c7", r1, 3, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c7.setAsTankMinion();

  var r1s1 = new Structure("r1s1", r1, 2.08, 0.54, true, null, 0, 0);
  r1s1.setAsWoodenSign();
  r1s1.interact = function() {dialog("This way to Norwich");};

  var r1s2 = new Structure("r1s2", r1, 2.2, 0.51, false, null, 0, 0);
  r1s2.setAsWoodenSign();
  r1s2.interact = function() {dialog("This way to Hemel");};

  var r1s3 = new Structure("r1s3", r1, 1.5, 0.31, false, null, 0, 0);
  r1s3.setAsSmallTree();
};

World.prototype.create_tw3 = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return this.charIsRescued("r1c1");};

  var r1 = new Room("r1", this, 5, 0.7, [new Point(0, 0.9), new Point(0.3, 0.9), new Point(0.4, 0.8), new Point(5, 0.8)], new Sprite("texture", "concrete"), 100, 110, 120, new Sprite("texture", "stone wall"), 100, 150, 255, "3");

  var r1s1 = new Structure("r1s1", r1, 0.5, 0.51, false, null, 0, 0);
  r1s1.setAsLargeCrateRed();

  var r1s2 = new Structure("r1s2", r1, 1.5, 0.51, false, null, 0, 0);
  r1s2.setAsLargeCrateGrey();

  var r1s3 = new Structure("r1s3", r1, 2.1, 0.51, false, null, 0, 0);
  r1s3.setAsLargeCrateWhite();

  var r1sh1 = new Structure("r1sh1", r1, 1.1, 0.44, false, null, 0, 0);
  r1sh1.setAsFaintShadow();

  var r1sh2 = new Structure("r1sh2", r1, 1.6, 0.44, false, null, 0, 0);
  r1sh2.setAsFaintShadow();

  var r1sh3 = new Structure("r1sh3", r1, 2.2, 0.44, false, null, 0, 0);
  r1sh3.setAsFaintShadow();

  var r1c1 = new Character("r1c1", r1, 0.3, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("A", "B", "C", "D", "E"));
  r1c1.setAsCivilianMinion();
  r1c1.interact = function() {dialog("I make an excellent chef. Recruit me?", [new DialogOption("Yes", function() {dialog("Off we go then!"); getById("r1c1").rescue();}), new DialogOption("Nah", function() {dialog("Suit yourself.");})]);};

  var r1c2 = new Character("r1c2", r1, 0.35, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("S++", "S+", "S", "A++", "A+"));
  r1c2.setAsCivilianMinion();
  r1c2.interact = function() {dialog("I'm far better than the other guy. Recruit me?", [new DialogOption("Yes", function() {dialog("Off we go then!"); getById("r1c2").rescue();}), new DialogOption("Nah", function() {dialog("Suit yourself.");})]);};

  var r1c3 = new Character("r1c3", r1, 0.4, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c3.setAsCivilianMinion();

  var r1c4 = new Character("r1c4", r1, 0.45, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c4.setAsCivilianMinion();

  var r1c5 = new Character("r1c5", r1, 0.5, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c5.setAsCivilianMinion();

  var r1g1 = new Gun("r1g1", r1, null, 0.1, 0, false);
  r1g1.setAsShotgun();

  var r1e1 = new Character("r1e1", r1, 2, 0, true, new PatrolRoute([new WaitStep(1), new PatrolStep(1.5), new WaitStep(3), new PatrolStep(2.7)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1e1.setAsGuardMinion();

  var r1e2 = new Character("r1e2", r1, 2.1, 0, true, new PatrolRoute([new WaitStep(5), new PatrolStep(1.3), new WaitStep(4.4), new PatrolStep(2)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1e2.setAsGuardMinion();

  var r1e3 = new Character("r1e3", r1, 2.2, 0, true, new PatrolRoute([new WaitStep(3), new PatrolStep(1.6), new WaitStep(7), new PatrolStep(2.3)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1e3.setAsGuardMinion();

  var r1e1g = new Gun("r1e1g", r1, r1e1, 0, 0, false);
  r1e1g.setAsShotgun();

  var r1e2g = new Gun("r1e2g", r1, r1e2, 0, 0, false);
  r1e2g.setAsShotgun();

  var r1e3g = new Gun("r1e3g", r1, r1e3, 0, 0, false);
  r1e3g.setAsFlameThrower();
};

World.prototype.create_rescueNimler = function()
{
  this.missionFailed = function() {return this.charIsDead("Nimler");};
  this.missionSuccess = function() {return this.charIsRescued("Nimler");};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.8), new Point(0.5, 0.8), new Point(0.6, 0.7), new Point(1.1, 0.7), new Point(1.6, 0.6), new Point(1.8, 0.6), new Point(2, 0.65), new Point(2.5, 0.6), new Point(2.8, 0.5), new Point(3, 0.4), new Point(3.6, 0.5), new Point(4, 0.4), new Point(4.4, 0.5), new Point(5, 0.48)], new Sprite("texture", "sand"), 0, 0, 0, new Sprite("texture", "sky"), 0, 0, 0, "3");
  var r2 = new Room("r2", this, 1, 1, [new Point(0, 0.7), new Point(1, 0.7)], new Sprite("texture", "sand"), 0, 0, 0, new Sprite("texture", "wall"), 0, 0, 0, "1");

  var r1s1 = new Structure("r1s1", r1, 0.4, 0.62, false, null, 0, 0);
  r1s1.setAsWoodenSign();
  r1s1.interact = function() {dialog("Abandoned camp up ahead");};

  var r1s2 = new Structure("r1s2", r1, 4.45, 0, false, null, 0, 0);
  r1s2.setAsShack();

  var r1s2door = new Structure("r1s2door", r1, 4.75, 0.3, false, r2, 0.2, 0);
  r1s2door.setAsShackDoor();

  var r2s1door = new Structure("r2s1door", r2, 0.15, 0.5, false, r1, 4.8, 0);
  r2s1door.setAsShackDoor();

  var Nimler = new Character("Nimler", r2, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), null);
  Nimler.setAsPrisonerMinion();
  Nimler.interact = function() {getById("Nimler").untieHostage(); dialog("A rescue eh. Let's go " + playerName + ".", [new DialogOption("Yes", function() {dialog("Good."); getById("Nimler").rescue();}), new DialogOption("No", function() {dialog("Then why are you even here? Get out.");})]);};
};

World.prototype.create_mb = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return false;};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.9), new Point(0.5, 0.9), new Point(0.55, 0.87), new Point(0.75, 0.87), new Point(0.8, 0.9), new Point(5, 0.9)], new Sprite("texture", "concrete"), 0, 0, 0, new Sprite("texture", "sky"), 0, 0, 0, "mb");

  if (charIsRescued("Nimler"))
  {
    var Nimler = new Character("Nimler", r1, 0.3, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Nimler.setAsNimler();
    Nimler.interact = function() {dialogNimler();};
  }

  if (!structureIsBuilt("MbItemShop"))
  {
    var MbItemShop = new Structure("MbItemShop", r1, 0.5, 0.55, false, null, 0, 0);
    MbItemShop.setAsBuildShop();
    MbItemShop.interact = function() {if (this.buildAs != null) {this.tryBuild("Item shop");}};
  }

  if (structureIsBuilt("MbItemShop") && !charIsRescued("Johnny"))
  {
    var MbItemShop = new Structure("MbItemShop", r1, 0.5, 0.55, false, null, 0, 0);
    MbItemShop.setAsClosedShop();
  }

  if (structureIsBuilt("MbItemShop") && charIsRescued("Johnny"))
  {
    var MbItemShop = new Structure("MbItemShop", r1, 0.5, 0.55, false, null, 0, 0);
    MbItemShop.setAsItemShop();
  }

  if (structureIsBuilt("MbItemShop") && charIsRescued("Johnny"))
  {
    var Johnny = new Character("Johnny", r1, 0.6, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Johnny.setAsShopkeeperMinion();
    Johnny.interact = function() {dialogJohnny();};
  }

  if (!structureIsBuilt("MbItemShop") && charIsRescued("Johnny"))
  {
    var Johnny = new Character("Johnny", r1, 0.5, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Johnny.setAsShopkeeperMinion();
    Johnny.interact = function() {if (structureIsBuilt("MbItemShop")) {dialog("Good job " + playerName + ". Come back later when I've got everything set up.");} else {dialog("Hey " + playerName + ". While standing in front of the white outline of a structure, you have the option to build it if you have the right skill and materials available. Try building this item shop and we can start using it.");}};
  }

  if (!structureIsBuilt("MbGunShop"))
  {
    var MbGunShop = new Structure("MbGunShop", r1, 0.8, 0.58, false, null, 0, 0);
    MbGunShop.setAsBuildShop();
    MbGunShop.interact = function() {if (this.buildAs != null) {this.tryBuild("Gun shop");}};
  }

  if (structureIsBuilt("MbGunShop") && !charIsRescued("Carter"))
  {
    var MbGunShop = new Structure("MbGunShop", r1, 0.8, 0.58, false, null, 0, 0);
    MbGunShop.setAsClosedShop();
  }

  if (structureIsBuilt("MbGunShop") && charIsRescued("Carter"))
  {
    var MbGunShop = new Structure("MbGunShop", r1, 0.8, 0.58, false, null, 0, 0);
    MbGunShop.setAsGunShop();
  }

  if (structureIsBuilt("MbGunShop") && charIsRescued("Carter"))
  {
    var Carter = new Character("Carter", r1, 0.9, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Carter.setAsShopkeeperMinion();
    Carter.interact = function() {dialogCarter();};
  }

  if (!structureIsBuilt("MbGunShop") && charIsRescued("Carter"))
  {
    var Carter = new Character("Carter", r1, 0.8, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Carter.setAsShopkeeperMinion();
    Carter.interact = function() {if (structureIsBuilt("MbGunShop")) {dialog("Nice one " + playerName + ". I'll get a few things set up for you. Come see me again.");} else {dialog(playerName + ", we could use a gun shop established here. I can maintain it and provide supplies to you and " + teamName + ", as well as arrange for upgrades to be developed.");}};
  }

  if (charIsRescued("Sara"))
  {
    var Sara = new Character("Sara", r1, 1.2, 0, true, new PatrolRoute([new WaitStep(100)]), null);
    Sara.setAsFemaleMinion();
    Sara.interact = function() {dialog("Hey " + playerName + ". My name's Sara. How are you?");};
  }
};

World.prototype.create_rescueJohnny = function()
{
  this.missionFailed = function() {return this.charIsDead("Johnny");};
  this.missionSuccess = function() {return this.charIsRescued("Johnny");};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.6), new Point(5, 0.6)], new Sprite("texture", "sand"), 0, 0, 0, null, 150, 175, 200, "0");
  var r2 = new Room("r2", this, 1, 1, [new Point(0, 0.7), new Point(1, 0.7)], new Sprite("texture", "sand"), 0, 0, 0, new Sprite("texture", "wall"), 0, 0, 0, "1");

  var r1c1 = new Character("r1c1", r1, 0.5, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c1.setAsCivilianMinion();
  r1c1.interact = function() {if (this.interactCount % 2 == 1) {dialog("Hide in the shadows. Enemies can't see you!");} else {dialog("Johnny? Yeah, he's up ahead taking care of the inventory.");}};

  var r1c1i = new Item("r1c1i", r1, r1c1, 0, 0);
  r1c1i.setAsCoin();

  var r1c2 = new Character("r1c2", r1, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  r1c2.setAsCivilianMinion();
  r1c2.interact = function() {if (this.interactCount % 2 == 1) {dialog("When standing next to somebody like this, you can hold the Z key to attack with your knife.");} else {dialog("Johnny's the inventory manager for the outpost here. He's very organised.");}};

  var r1c2i = new Item("r1c2i", r1, r1c2, 0, 0);
  r1c2i.setAsCoin();

  var r1sh1 = new Structure("r1sh1", r1, 1.1, 0.14, false, null, 0, 0);
  r1sh1.setAsFullShadow();

  var r1sh2 = new Structure("r1sh2", r1, 2.5, 0.14, false, null, 0, 0);
  r1sh2.setAsFullShadow();

  var r1sh3 = new Structure("r1sh3", r1, 3.4, 0.14, false, null, 0, 0);
  r1sh3.setAsFullShadow();

  var guard1 = new Character("guard1", r1, 4, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(2), new WaitStep(3), new PatrolStep(4)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  guard1.setAsGuardMinion();

  var guard1g = new Gun("guard1g", r1, guard1, 0, 0, false);
  guard1g.setAsHandgun();

  var guard1i = new Item("guard1i", r1, guard1, 0, 0);
  guard1i.setAsCoin();

  var r1s2 = new Structure("r1s2", r1, 4.45, 0.1, false, null, 0, 0);
  r1s2.setAsShack();

  var r1s2door = new Structure("r1s2door", r1, 4.77, 0.4, false, r2, 0.2, 0);
  r1s2door.setAsShackDoor();

  var r2s1 = new Structure("r2s1", r2, 0.15, 0.5, false, r1, 4.85, 0);
  r2s1.setAsShackDoor();

  var Johnny = new Character("Johnny", r2, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), null);
  Johnny.setAsCivilianMinion();
  Johnny.interact = function() {dialog("Who are you?", [new DialogOption("I need you", function() {dialog("Right sure, so what are you offering if I join you?", [new DialogOption("More money", function() {dialog("Great I guess. Ok, I'll come with you."); getById("Johnny").rescue();}), new DialogOption("I kill you otherwise", function() {dialog("Um ok, I'll come with you."); getById("Johnny").rescue();})]);}), new DialogOption("Just looking", function() {dialog("Ok whatever. Just don't touch anything.");})]);};
};

World.prototype.create_rescueCarter = function()
{
  this.missionFailed = function() {return this.charIsDead("Carter");};
  this.missionSuccess = function() {return this.charIsRescued("Carter");};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.6), new Point(0.3, 0.65), new Point(0.7, 0.55), new Point(1, 0.58), new Point(1.3, 0.66), new Point(1.7, 0.6), new Point(2, 0.55), new Point(2.5, 0.5), new Point(3, 0.48), new Point(3.3, 0.54), new Point(4, 0.48), new Point(4.4, 0.57), new Point(4.8, 0.55), new Point(5, 0.57)], new Sprite("texture", "dirt"), 0, 0, 0, new Sprite("texture", "sky"), 0, 0, 0, "6");
  var r2 = new Room("r2", this, 1, 1, [new Point(0, 0.7), new Point(1, 0.7)], new Sprite("texture", "dirt"), 0, 0, 0, new Sprite("texture", "wall"), 0, 0, 0, "1");

  var guard1 = new Character("guard1", r1, 1.8, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(0.5), new WaitStep(3), new PatrolStep(4)]), new CharacterSkillSet("D", "E", "E", "E", "E"));
  guard1.setAsGuardMinion();

  var guard2 = new Character("guard2", r1, 2.9, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(1.3), new WaitStep(3), new PatrolStep(4.5)]), new CharacterSkillSet("E", "D", "E", "E", "E"));
  guard2.setAsGuardMinion();

  var guard3 = new Character("guard3", r1, 3.7, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(2.1), new WaitStep(3), new PatrolStep(3.6)]), new CharacterSkillSet("E", "E", "D", "E", "E"));
  guard3.setAsGuardMinion();

  var guard4 = new Character("guard4", r1, 4.4, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(0.9), new WaitStep(3), new PatrolStep(2.8)]), new CharacterSkillSet("E", "E", "E", "D", "E"));
  guard4.setAsGuardMinion();

  var guardg1 = new Gun("guardg1", r1, guard1, 0, 0, false);
  guardg1.setAsHandgun();

  var guardg2 = new Gun("guardg2", r1, guard2, 0, 0, false);
  guardg2.setAsHandgun();

  var guardg3 = new Gun("guardg3", r1, guard3, 0, 0, false);
  guardg3.setAsHandgun();

  var guardg4 = new Gun("guardg4", r1, guard4, 0, 0, false);
  guardg4.setAsHandgun();

  var guardi1 = new Item("guardi1", r1, guard1, 0, 0);
  guardi1.setAsCoin();

  var guardi2 = new Item("guardi2", r1, guard2, 0, 0);
  guardi2.setAsCoin();

  var guardi3 = new Item("guardi3", r1, guard3, 0, 0);
  guardi3.setAsCoin();

  var guardi4 = new Item("guardi4", r1, guard4, 0, 0);
  guardi4.setAsCoin();

  var r1sh1 = new Structure("r1sh1", r1, 1, 0.3, false, null, 0, 0);
  r1sh1.setAsFullShadow();

  var r1sh2 = new Structure("r1sh2", r1, 2, 0.3, false, null, 0, 0);
  r1sh2.setAsFullShadow();

  var r1sh3 = new Structure("r1sh3", r1, 3, 0.3, false, null, 0, 0);
  r1sh3.setAsFullShadow();

  var r1sh4 = new Structure("r1sh4", r1, 4, 0.3, false, null, 0, 0);
  r1sh4.setAsFullShadow();

  var r1sh5 = new Structure("r1sh5", r1, 0.1, 0.3, false, null, 0, 0);
  r1sh5.setAsFullShadow();

  var r1s2 = new Structure("r1s2", r1, 4.45, 0.17, false, null, 0, 0);
  r1s2.setAsShack();

  var r1s2door = new Structure("r1s2door", r1, 4.77, 0.47, false, r2, 0.2, 0);
  r1s2door.setAsShackDoor();

  var r2s1 = new Structure("r2s1", r2, 0.15, 0.5, false, r1, 4.85, 0);
  r2s1.setAsShackDoor();

  var Carter = new Character("Carter", r2, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), null);
  Carter.setAsCivilianMinion();
  Carter.interact = function() {var armed = this.room.world.player.gun != null; var msg; if (armed) {msg = "Woah! Don't shoot.";} else {msg = "What are you doing in here?";} dialog(msg, [new DialogOption("I need you to advance the plot", function() {dialog("Cool, let's go."); getById("Carter").rescue();}), new DialogOption("Never mind", function() {dialog("See ya.");})]);};
};

World.prototype.create_recruitInitialStaff = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return this.hasEscaped();;};

  var r1 = new Room("r1", this, 2, 1, [new Point(0, 0.6), new Point(2, 0.6)], new Sprite("texture", "dirt"), 0, 0, 0, new Sprite("texture", "sky"), 0, 0, 0, "5");

  var wood1 = new Item("wood1", r1, null, 0.5, 0);
  wood1.setAsWood();

  var crummy1 = new Character("crummy1", r1, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), new CharacterSkillSet("E", "E", "D", "E", "E"));
  crummy1.setAsCivilianMinion();
  crummy1.interact = function() {var armed = this.room.world.player.gun != null; var msg; if (armed) {msg = "Woah! Don't shoot.";} else {msg = "What are you doing in here?";} dialog(msg, [new DialogOption("I need you to advance the plot", function() {dialog("Cool, let's go."); getById("crummy1").rescue();}), new DialogOption("Never mind", function() {dialog("See ya.");})]);};

  var heli = new Structure("heli", r1, 1.5, 0.3, false, null, 0, 0);
  heli.setAsHelicopter();
};

World.prototype.create_eliminateSara = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return this.charIsNeutralised("Sara");};

  var r1 = new Room("r1", this, 1, 1, [new Point(0, 0.6), new Point(1, 0.6)], new Sprite("texture", "dirt"), 0, 0, 0, new Sprite("texture", "sky"), 0, 0, 0, "6");

  var sign1 = new Structure("sign1", r1, 0.4, 0.42, false, null, 0, 0);
  sign1.setAsWoodenSign();
  sign1.interact = function() {dialog("Incomplete level. Just deal with the target.");};

  var Sara = new Character("Sara", r1, 0.7, 0, true, new PatrolRoute([new WaitStep(100)]), null);
  Sara.setAsFemaleMinion();
  Sara.interact = function() {dialog("Recruit Sara?", [new DialogOption("Yes", function() {dialog("Cool, let's go."); getById("Sara").rescue();}), new DialogOption("No", function() {dialog("See ya.");})]);};

  var testSign = new Structure("testSign", r1, 0.05, 0.42, true, null, 0, 0);
  testSign.setAsBuildSign();
  testSign.interact = function() {if (this.buildAs != null) {this.tryBuild("Sign to Stilton");} else {dialog("This way to Stilton");}};
};

World.prototype.create_clearOilfield = function()
{
  this.missionFailed = function() {return false;};
  this.missionSuccess = function() {return this.allThreatsNeutralised();};

  var r1 = new Room("r1", this, 5, 1, [new Point(0, 0.6), new Point(0.3, 0.65), new Point(0.7, 0.55), new Point(1, 0.58), new Point(1.3, 0.66), new Point(1.7, 0.6), new Point(2, 0.55), new Point(2.5, 0.5), new Point(3, 0.48), new Point(3.3, 0.54), new Point(4, 0.48), new Point(4.4, 0.57), new Point(4.8, 0.66), new Point(5, 0.63)], new Sprite("texture", "dirt"), 0, 0, 0, null, 50, 50, 200, "6");

  var guard1 = new Character("guard1", r1, 1.8, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(0.5), new WaitStep(3), new PatrolStep(4)]), new CharacterSkillSet("D", "E", "E", "E", "E"));
  guard1.setAsGuardMinion();

  var guard2 = new Character("guard2", r1, 2.9, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(1.3), new WaitStep(3), new PatrolStep(4.5)]), new CharacterSkillSet("E", "D", "E", "E", "E"));
  guard2.setAsGuardMinion();

  var guard3 = new Character("guard3", r1, 3.7, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(2.1), new WaitStep(3), new PatrolStep(3.6)]), new CharacterSkillSet("E", "E", "D", "E", "E"));
  guard3.setAsGuardMinion();

  var guard4 = new Character("guard4", r1, 4.4, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(0.9), new WaitStep(3), new PatrolStep(2.8)]), new CharacterSkillSet("E", "E", "E", "D", "E"));
  guard4.setAsGuardMinion();

  var guard5 = new Character("guard5", r1, 3.5, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(3), new WaitStep(3), new PatrolStep(4.8)]), new CharacterSkillSet("E", "E", "E", "E", "D"));
  guard5.setAsGuardMinion();

  var guard6 = new Character("guard6", r1, 1.3, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(0.1), new WaitStep(3), new PatrolStep(3.9)]), new CharacterSkillSet("D", "D", "E", "E", "E"));
  guard6.setAsGuardMinion();

  var guard7 = new Character("guard7", r1, 1.5, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(2), new WaitStep(3), new PatrolStep(4)]), new CharacterSkillSet("D", "E", "D", "E", "E"));
  guard7.setAsGuardMinion();

  var guard8 = new Character("guard8", r1, 2.7, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(1), new WaitStep(3), new PatrolStep(2)]), new CharacterSkillSet("D", "E", "E", "D", "E"));
  guard8.setAsGuardMinion();

  var guard9 = new Character("guard9", r1, 4.1, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(1.3), new WaitStep(3), new PatrolStep(4)]), new CharacterSkillSet("D", "E", "E", "E", "D"));
  guard9.setAsGuardMinion();

  var guard10 = new Character("guard10", r1, 3.3, 0, false, new PatrolRoute([new WaitStep(3), new PatrolStep(4), new WaitStep(3), new PatrolStep(4.4)]), new CharacterSkillSet("E", "E", "E", "E", "E"));
  guard10.setAsGuardMinion();

  var guardg1 = new Gun("guardg1", r1, guard1, 0, 0, false);
  guardg1.setAsHandgun();

  var guardg2 = new Gun("guardg2", r1, guard2, 0, 0, false);
  guardg2.setAsHandgun();

  var guardg3 = new Gun("guardg3", r1, guard3, 0, 0, false);
  guardg3.setAsHandgun();

  var guardg4 = new Gun("guardg4", r1, guard4, 0, 0, false);
  guardg4.setAsHandgun();

  var guardg5 = new Gun("guardg5", r1, guard5, 0, 0, false);
  guardg5.setAsHandgun();

  var guardg6 = new Gun("guardg6", r1, guard6, 0, 0, false);
  guardg6.setAsHandgun();

  var guardg7 = new Gun("guardg7", r1, guard7, 0, 0, false);
  guardg7.setAsHandgun();

  var guardg8 = new Gun("guardg8", r1, guard8, 0, 0, false);
  guardg8.setAsHandgun();

  var guardg9 = new Gun("guardg9", r1, guard9, 0, 0, false);
  guardg9.setAsHandgun();

  var guardg10 = new Gun("guardg10", r1, guard10, 0, 0, false);
  guardg10.setAsHandgun();

  var guardi1 = new Item("guardi1", r1, guard1, 0, 0);
  guardi1.setAsCoin();

  var guardi2 = new Item("guardi2", r1, guard2, 0, 0);
  guardi2.setAsCoin();

  var guardi3 = new Item("guardi3", r1, guard3, 0, 0);
  guardi3.setAsCoin();

  var guardi4 = new Item("guardi4", r1, guard4, 0, 0);
  guardi4.setAsCoin();

  var guardi5 = new Item("guardi5", r1, guard5, 0, 0);
  guardi5.setAsCoin();

  var guardi6 = new Item("guardi6", r1, guard6, 0, 0);
  guardi6.setAsCoin();

  var guardi7 = new Item("guardi7", r1, guard7, 0, 0);
  guardi7.setAsCoin();

  var r1sh1 = new Structure("r1sh1", r1, 1, 0.3, false, null, 0, 0);
  r1sh1.setAsFullShadow();

  var r1sh2 = new Structure("r1sh2", r1, 2, 0.3, false, null, 0, 0);
  r1sh2.setAsFullShadow();

  var r1sh3 = new Structure("r1sh3", r1, 3, 0.3, false, null, 0, 0);
  r1sh3.setAsFullShadow();

  var r1sh4 = new Structure("r1sh4", r1, 4, 0.3, false, null, 0, 0);
  r1sh4.setAsFullShadow();

  var r1sh5 = new Structure("r1sh5", r1, 0.1, 0.3, false, null, 0, 0);
  r1sh5.setAsFullShadow();
};

Character.prototype.setAsNimler = function()
{
  this.w = 0.1;
  this.h = 0.12;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.0005;
  this.sprite = null;
  this.maxHp = 1000;
  this.hp = 1000;
  this.shootOnSight = false;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 200), new Rgb(242, 242, 222), new Rgb(125, 200, 100), new Rgb(222, 211, 200), new Rgb(200, 225, 90));};
};

Character.prototype.setAsCivilianMinion = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.001;
  this.sprite = null;
  this.maxHp = 1;
  this.hp = 1;
  this.shootOnSight = false;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(200, 200, 222), new Rgb(222, 211, 150), new Rgb(100, 111, 99));};
};

Character.prototype.setAsGuardMinion = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.002;
  this.sprite = null;
  this.maxHp = 150;
  this.hp = 150;
  this.shootOnSight = true;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(222, 150, 100), new Rgb(222, 211, 150), new Rgb(100, 111, 99));};
};

Character.prototype.setAsTankMinion = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.002;
  this.sprite = null;
  this.maxHp = 1000;
  this.hp = 1000;
  this.shootOnSight = true;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(150, 150, 150), new Rgb(222, 211, 150), new Rgb(150, 150, 150));};
};

Character.prototype.setAsShopkeeperMinion = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.001;
  this.sprite = null;
  this.maxHp = 1;
  this.hp = 1;
  this.shootOnSight = false;
  this.isForeground = false;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(200, 200, 222), new Rgb(222, 211, 150), new Rgb(100, 111, 99));};
};

Character.prototype.setAsPrisonerMinion = function()
{
  this.w = 0.1;
  this.h = 0.1;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.001;
  this.sprite = null;
  this.maxHp = 1;
  this.hp = 1;
  this.shootOnSight = false;
  this.isForeground = true;
  this.hostage = true;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 200), new Rgb(242, 242, 222), new Rgb(125, 200, 100), new Rgb(222, 211, 200), new Rgb(200, 225, 90));};
};

Character.prototype.setAsStickMinion = function()
{
  this.w = 0.1;
  this.h = 0.33;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.001;
  this.sprite = null;
  this.maxHp = 1000;
  this.hp = 1000;
  this.shootOnSight = true;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(200, 200, 222), new Rgb(222, 211, 150), new Rgb(100, 111, 99));};
};

Character.prototype.setAsFemaleMinion = function()
{
  this.w = 0.1;
  this.h = 0.33;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.speed = 0.001;
  this.sprite = null;
  this.maxHp = 1000;
  this.hp = 1000;
  this.shootOnSight = true;
  this.isForeground = true;
  this.hostage = false;
  this.sketch = function(ctx, w, h, brightness) {this.sketchMinion(ctx, w, h, brightness, new Rgb(222, 211, 150), new Rgb(222, 222, 222), new Rgb(200, 150, 150), new Rgb(222, 211, 150), new Rgb(200, 111, 200));};
};

Structure.prototype.setAsWoodenSign = function()
{
  this.w = 0.15;
  this.h = 0.2;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchSign(ctx, w, h, brightness, new Rgb(150, 120, 80));};
};

Structure.prototype.setAsSmallTree = function()
{
  this.w = 0.4;
  this.h = 0.4;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) / 2;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchTree(ctx, w, h, brightness, new Rgb(150, 120, 80), new Rgb(100, 255, 100));};
};

Structure.prototype.setAsShack = function()
{
  this.w = 0.5;
  this.h = 0.5;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI);};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShack(ctx, w, h, brightness, new Rgb(100, 80, 30));};
};

Structure.prototype.setAsShackDoor = function()
{
  this.w = 0.15;
  this.h = 0.2;
  this.doorX = 0;
  this.doorWidth = 1;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchDoor(ctx, w, h, brightness, new Rgb(150, 120, 60));};
};

Structure.prototype.setAsLargeCrateRed = function()
{
  this.w = 0.5;
  this.h = 0.3;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 0;
  this.b = 0;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) / 2;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchCrate(ctx, w, h, brightness, new Rgb(255, 100, 100));};
};

Structure.prototype.setAsLargeCrateGrey = function()
{
  this.w = 0.5;
  this.h = 0.3;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 0.6;
  this.g = 0.6;
  this.b = 0.6;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) / 2;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchCrate(ctx, w, h, brightness, new Rgb(150, 150, 150));};
};

Structure.prototype.setAsLargeCrateWhite = function()
{
  this.w = 0.5;
  this.h = 0.3;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) / 2;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchCrate(ctx, w, h, brightness, new Rgb(222, 222, 222));};
};

Structure.prototype.setAsFaintShadow = function()
{
  this.w = 0.6;
  this.h = 0.5;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) - 0.2;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShadow(ctx, w, h, brightness, 0.5);};
};

Structure.prototype.setAsFullShadow = function()
{
  this.w = 0.6;
  this.h = 0.5;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.getShadowIntensity = function(x) {var pos = Math.min(Math.max((x - this.x) / this.w, 0), 1); return Math.sin(pos * Math.PI) - 0.05;};
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShadow(ctx, w, h, brightness, 1);};
};

Structure.prototype.setAsClosedShop = function()
{
  this.w = 0.3;
  this.h = 0.4;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShop(ctx, w, h, brightness, new Rgb(150, 150, 150));};
};

Structure.prototype.setAsItemShop = function()
{
  this.w = 0.3;
  this.h = 0.4;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShop(ctx, w, h, brightness, new Rgb(200, 200, 255));};
};

Structure.prototype.setAsGunShop = function()
{
  this.w = 0.3;
  this.h = 0.4;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchShop(ctx, w, h, brightness, new Rgb(255, 200, 200));};
};

Structure.prototype.setAsBuildSign = function()
{
  this.w = 0.15;
  this.h = 0.2;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 1;
  this.constructionResources = [["Wood", 5]];
  this.buildAs = this.setAsWoodenSign; if (structureIsBuilt(this.id)) {this.buildAs();};
  this.sketch = function(ctx, w, h, brightness) {this.sketchSign(ctx, w, h, brightness, new Rgb(255, 255, 255));};
};

Structure.prototype.setAsBuildShop = function()
{
  this.w = 0.3;
  this.h = 0.4;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = false;
  this.isStageExit = false;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 3;
  this.constructionResources = [["Wood", 50]];
  this.buildAs = this.setAsClosedShop; if (structureIsBuilt(this.id)) {this.buildAs();};
  this.sketch = function(ctx, w, h, brightness) {this.sketchShop(ctx, w, h, brightness, new Rgb(255, 255, 255));};
};

Structure.prototype.setAsHelicopter = function()
{
  this.w = 0.4;
  this.h = 0.3;
  this.doorX = 0;
  this.doorWidth = 0;
  this.isFlamable = true;
  this.isStageExit = true;
  this.sprite = null;
  this.r = 1;
  this.g = 1;
  this.b = 1;
  this.constructionLevel = 0;
  this.constructionResources = [];
  this.buildAs = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchHelicopter(ctx, w, h, brightness, new Rgb(100, 250, 100));};
};

Gun.prototype.setAsHandgun = function()
{
  this.w = 0.025;
  this.h = 0.025;
  this.fireRate = 500;
  this.rapidFire = false;
  this.damage = 20;
  this.range = 0.2;
  this.recoil = 0.005;
  this.shotForce = 0.01;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "handgun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchHandgun(ctx, w, h, brightness, new Rgb(50, 20, 60));};
};

Gun.prototype.setAsTranqGun = function()
{
  this.w = 0.025;
  this.h = 0.025;
  this.fireRate = 1200;
  this.rapidFire = false;
  this.damage = 10;
  this.range = 0.1;
  this.recoil = 0;
  this.shotForce = 0.001;
  this.burn = false;
  this.projectileType = "tranq";
  this.sprite = null;
  this.sound = "tranquiliser gun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchHandgun(ctx, w, h, brightness, new Rgb(50, 20, 160));};
};

Gun.prototype.setAsMachineGun = function()
{
  this.w = 0.05;
  this.h = 0.05;
  this.fireRate = 100;
  this.rapidFire = true;
  this.damage = 10;
  this.range = 0.2;
  this.recoil = 0.005;
  this.shotForce = 0.01;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "machine gun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchMachineGun(ctx, w, h, brightness, new Rgb(50, 220, 60));};
};

Gun.prototype.setAsShotgun = function()
{
  this.w = 0.05;
  this.h = 0.05;
  this.fireRate = 1000;
  this.rapidFire = false;
  this.damage = 100;
  this.range = 0.1;
  this.recoil = 0.01;
  this.shotForce = 0.02;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "shotgun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchShotgun(ctx, w, h, brightness, new Rgb(150, 20, 60));};
};

Gun.prototype.setAsFlameThrower = function()
{
  this.w = 0.05;
  this.h = 0.025;
  this.fireRate = 250;
  this.rapidFire = true;
  this.damage = 0;
  this.range = 0.1;
  this.recoil = 0;
  this.shotForce = 0;
  this.burn = true;
  this.projectileType = "flame";
  this.sprite = null;
  this.sound = "flame thrower";
  this.sketch = function(ctx, w, h, brightness) {this.sketchFlameThrower(ctx, w, h, brightness, new Rgb(250, 220, 60));};
};

Gun.prototype.setAsHandgun2 = function()
{
  this.w = 0.025;
  this.h = 0.025;
  this.fireRate = 400;
  this.rapidFire = false;
  this.damage = 25;
  this.range = 0.22;
  this.recoil = 0.0045;
  this.shotForce = 0.011;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "handgun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchHandgun(ctx, w, h, brightness, new Rgb(50, 20, 60));};
};

Gun.prototype.setAsTranqGun2 = function()
{
  this.w = 0.025;
  this.h = 0.025;
  this.fireRate = 900;
  this.rapidFire = false;
  this.damage = 15;
  this.range = 0.12;
  this.recoil = 0;
  this.shotForce = 0.0011;
  this.burn = false;
  this.projectileType = "tranq";
  this.sprite = null;
  this.sound = "tranquiliser gun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchHandgun(ctx, w, h, brightness, new Rgb(50, 20, 160));};
};

Gun.prototype.setAsMachineGun2 = function()
{
  this.w = 0.05;
  this.h = 0.05;
  this.fireRate = 90;
  this.rapidFire = true;
  this.damage = 12;
  this.range = 0.22;
  this.recoil = 0.0045;
  this.shotForce = 0.011;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "machine gun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchMachineGun(ctx, w, h, brightness, new Rgb(50, 220, 60));};
};

Gun.prototype.setAsShotgun2 = function()
{
  this.w = 0.05;
  this.h = 0.05;
  this.fireRate = 850;
  this.rapidFire = false;
  this.damage = 130;
  this.range = 0.12;
  this.recoil = 0.009;
  this.shotForce = 0.023;
  this.burn = false;
  this.projectileType = "bullet";
  this.sprite = null;
  this.sound = "shotgun";
  this.sketch = function(ctx, w, h, brightness) {this.sketchShotgun(ctx, w, h, brightness, new Rgb(150, 20, 60));};
};

Gun.prototype.setAsFlameThrower2 = function()
{
  this.w = 0.05;
  this.h = 0.025;
  this.fireRate = 250;
  this.rapidFire = true;
  this.damage = 0;
  this.range = 0.15;
  this.recoil = 0;
  this.shotForce = 0;
  this.burn = true;
  this.projectileType = "flame";
  this.sprite = null;
  this.sound = "flame thrower";
  this.sketch = function(ctx, w, h, brightness) {this.sketchFlameThrower(ctx, w, h, brightness, new Rgb(250, 220, 60));};
};

Item.prototype.setAsCoin = function()
{
  this.w = 0.02;
  this.h = 0.02;
  this.type = "Cash";
  this.value = Math.round(Math.random() * 25 + 5);
  this.sprite = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchCoin(ctx, w, h, brightness, new Rgb(222, 222, 22));};
};

Item.prototype.setAsFuel = function()
{
  this.w = 0.03;
  this.h = 0.03;
  this.type = "Fuel";
  this.value = Math.round(Math.random() * 25 + 5);
  this.sprite = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchFuel(ctx, w, h, brightness, new Rgb(200, 20, 20));};
};

Item.prototype.setAsWood = function()
{
  this.w = 0.03;
  this.h = 0.03;
  this.type = "Wood";
  this.value = Math.round(Math.random() * 25 + 5);
  this.sprite = null;
  this.sketch = function(ctx, w, h, brightness) {this.sketchWood(ctx, w, h, brightness, new Rgb(150, 120, 60));};
};

